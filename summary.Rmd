---
title: "Multinomial regression for Bogota Travel Survey"
author: "Zhanchao Yang"
date: "`r Sys.Date()`"
output:
  html_document:
    theme: flatly
    highlight: tango
    toc: true
    toc_float: true
    code_folding: hide
    code_download: yes
    mathjax: default
---
```{r, include = FALSE}
options(scipen=999)
library(tidyverse)
library(nnet)
library(haven)
library(dplyr)
library(tidyr)
library(tibble)
library(knitr)
library(kableExtra)
```

# Methods

## What is Multinomial Regression?

Multinomial regression is a statistical technique used to model the relationship between a categorical dependent variable with more than two levels and one or more independent variables. It is particularly useful when the outcome variable is nominal (i.e., categories without a natural order) and can be applied to survey data, such as the Bogotá Travel Survey.

The multinomial regression is the extension of binary logistic regression modeling categorical outcomes with more than two unordered categories. Rather than predicting a single probability as in logistic regression, it predicts a set of probabilities- one for each possible category of the dependent variable. The interpretation of the coefficients (**β**) is the change in log-odds of choosing category j over the baseline for a one-unit increase in predictor Xi, while holding all other variables constant.

Since P87-P101 consists of three categorical responses, “increase”, “not expected to see change”, and “expected to decrease”. The multinomial regression is suitable for determining the relationship between individuals' expectations and specific socio-economic predictors. The category of “not expected to see change” is used as the dependent variable baseline category.

## Formula

$$
\log\left(\frac{P(Y = j1)}{P(Y = \text{base})}\right) = \beta_{j0} + \beta_{j1}X_1 + \beta_{j2}X_2 + \cdots + \beta_{jp}X_p
$$
where:

- j1 is the category of the dependent variable (e.g., “increase”, “decrease”),
- \(Y\) is the categorical outcome variable,
- \(X_1, X_2, \ldots, X_p\) are the independent variables (predictors),
- \(\beta_{j0}\) is the intercept for category \(j\),
- \(\beta_{j1}, \beta_{j2}, \ldots, \beta_{jp}\) are the coefficients for the predictors in category \(j\).

In additional to that, multinomial regression is series of formulas for each category \(j\) compared to the baseline category (e.g., “not change”):

$$
\log\left(\frac{P(Y = j2)}{P(Y = \text{base})}\right) = \beta_{j0} + \beta_{j1}X_1 + \beta_{j2}X_2 + \cdots + \beta_{jp}X_p
$$
where:

- \(Y = j2\) is the second category of the dependent variable (e.g., “decrease”),
- \(Y = \text{base}\) is the baseline category (e.g., “not change”).

In short:

$$
\log\frac{P(Y = j \mid X)}{P(Y = 0 \mid X)}
=
\beta_{0j} + \beta_j^T X,
\quad j = 1, \dots, J
$$
In odd ratio form, the probabilities for each category \(j\) can be expressed as:

$$
P(Y = j \mid X)
=
\frac{\exp\bigl(\beta_{0j} + \beta_j^T X\bigr)}
     {1 + \displaystyle\sum_{k=1}^J \exp\bigl(\beta_{0k} + \beta_k^T X\bigr)},
\quad j = 1, \dots, J
$$

where:

- \(Y\) is the categorical outcome variable,
- \(X\) is the vector of predictors,
- \(\beta_{0j}\) is the intercept for category \(j\)
- \(\beta_j\) is the vector of coefficients for category \(j\).
- The reference category (baseline) is denoted as \(Y = 0\).

$$
P(Y = 0 \mid X)
=
\frac{1}
     {1 + \displaystyle\sum_{k=1}^J \exp\bigl(\beta_{0k} + \beta_k^T X\bigr)}
$$
where:

- \(P(Y = 0 \mid X)\) is the probability of the reference category given the predictors \(X\).


## Key Assumptions
There are three key assumptions for multinomial regression:

- **Independence of Irrelevant Alternatives (IIA)**: the odds between any two outcome categories do not depend on other alternatives. For example, the odds of people choosing to see increase or are influenced by options like “not change” and “decrease” present.
- **Independence observations**: We assume each individual person in our cases responded to the survey directly without being influenced by others who took the survey.
- **No perfect multicollinearity** among predictors

## Sample Interpretation

- The log-odds of responding “increase” (or “decrease”) vs “not change” are beta coefficient higher for categories one compared to reference categories.
- **Exponentiating (odd ratio)**: category one has `exp (β) - 1` percentage higher odds of choosing “increase” over not change compared to reference categories.

## Potential Predictors

All the predictors were treated as factors and regrouped to eliminate small sample categories. The specific variable, regrouping process, and reference category are listed below.

- Housing type (`P1`): 1- House, 2- Apartment, 3- Room in tenement, 4- other type of housing; *Other type of housing (4) was used as reference category.*
- Rent and Own (`P82`): 1 - Own, 2 - Rent; *Own was used as the reference category.*
- Gender (`P10`): 1 – female, 2 – male; *Female was used as the reference category.*
- Educational attainment (`P12`) with **recategorization**: Primary – primary school or lower, LowerSecondary -Junior high school complete, UpperSecondary – Senior high school complete (10th and 11th grades), Technological – technician/technological complete, University- University degree or higher; *Reference category: Upper secondary (high school complete)*
- Major Transportation mode before COVID-19 (`P42`) with **recategorization**: Public transit - including all buses (public), informal (private bus), taxi, driving, motorcycle, bike, walking, and others; *Reference category: other*
- Occupation (`P13`) with **recategorization**: student – include preschool, employed, self-employed, informal, NA, Others; *Reference category: other-employed*
- Income (`P50`) with **recategorization**: low- under 1,160, lower-mid – 1,161-2,500, upper-mid – 2,501 – 4,900, high – over 4,901; other (not answer); *Reference category: other*
- Live time (`P83`) with **recategorization**: short – less than or equal to 5 years, medium - More than 5 or less than or equal to 15 years, long – More than 15 years. *Reference category: medium *
- Age (`Edad`) with **recategorization**: under 18 years, 3,4,5,6,7 (without further recategorize) .*Reference category: 3*

## Inclusive and Exclusive Criteria

Since the primary purpose of the model is to identify different characteristics of people who have different expectations about the impact of the Bogotá Metro, we will use the following criteria to determine which predictors to include in the model (**explortary analysis rather than make prediction**):

**Inclusive Criteria**:

- P-values indicate the specific category is statistics significant

**Exclusive Criteria**:

- P-values indicate the specific category is not statistics significant (greater than 0.05)
- The sample size of the specific category is less than 30, which is too small to draw any conclusion.
- A coefficient this large often indicates near–perfect separation: in your data, whenever `X = k`, you almost never (or never) observe the baseline outcome. **It almost always signals (quasi-)perfect separation or very sparse data, so you’ll want to inspect your frequency tables and perhaps apply a regularization or category‐collapsing strategy.**
- **Meaningless categories**: such as **NA**, etc.

# Results

Since all **housing type** (P1) are statistically significant, we will not include it in the model, since all housing type shows signals of (quasi-)perfect separation, indicate that the housing type is not a good predictor for the dependent variable.( maybe because there is no significant difference between people in different household answer the survey differently or sample size is too small.)

## P87: Value of housing or rent

### Question:
**"How do you think the value of the housing or rent in which you live will change after the inauguration of the First and Second Line of the Bogotá Metro?"**

### Potential Answer:
- 1: Will increase
- 2: Will not change
- 3: Will decrease


```{r}

trips <- readRDS("data/008-24 BBDD Procesamiento Etapas.rds")
hog <- readRDS("data/008-24 BBDD Procesamiento Hogares.rds")
per <- readRDS("data/008-24 BBDD Procesamiento Personas.rds")

per_complt <- per %>%
  left_join(hog,by="ID_Hogar")

dependent_variable<- "P87"
independent_variables <- c("P3", "P42",
                           "P50", "P12", "P14",
                           "Edad", "P10", "P12","P13","P15", "P14", "P82", "P83")

regressor<- per_complt %>%
  select(all_of(dependent_variable), all_of(independent_variables))


regressor <- regressor %>%
  mutate(
    across(
      where(is.labelled),    # pick all haven_labelled columns
      ~ zap_labels(.)        # strip off the labels, leaving the underlying numeric
    )
  )
regressor$P87 <- as.factor(regressor$P87)
regressor$P87<-relevel(regressor$P87, ref = "2") # Relevel to set the reference category

regressor<-regressor%>%
  rename(pop_num=P3,
         major_trans_2020=P42,
         income= P50,
         rent_own= P82,
         live_time= P83
         )

regressor<-regressor%>%
  rename(edu_att= P12,
         occupation= P14,
         gender= P10,
         age= Edad
         )


regressor$rent_own<- as.factor(regressor$rent_own) # own =1, rent =2
regressor$rent_own <- relevel(regressor$rent_own, ref = "1") # Relevel to set the reference category
regressor$gender <- as.factor(regressor$gender) #female =1, male=2
regressor$gender <- relevel(regressor$gender, ref = "2") # Relevel to set the reference category


regressor$edu_att <- dplyr::case_when(
  regressor$edu_att %in% c(1, 2, 3) ~ "Primary",
  regressor$edu_att %in% c(4, 5) ~ "LowerSecondary",
  regressor$edu_att %in% c(6, 7) ~ "UpperSecondary",
  regressor$edu_att %in% c(8, 9) ~ "Technological",
  regressor$edu_att %in% c(10, 11, 12, 13) ~ "University",
  regressor$edu_att == 97 ~ "NA",
)
regressor$edu_att <- as.factor(regressor$edu_att)
regressor$edu_att <- relevel(regressor$edu_att, ref = "UpperSecondary") # Relevel to set the reference category

regressor<-regressor %>%
  mutate(major_trans_2020= case_when(
    major_trans_2020 %in% c(1,2,3,4,5,6,10,16) ~ "public_tansit",
    major_trans_2020 %in% c(7,8,9) ~ "informal",
    major_trans_2020 %in% c(11,12) ~ "taxi",
    major_trans_2020 %in% c(22,23) ~ "personal_veh",
    major_trans_2020 %in% c(24,25) ~"motorcyle",
    major_trans_2020 %in% c(25,27,28,17) ~ "bicycle",
    major_trans_2020==34 ~ "walking",
    TRUE ~ "other"
))
regressor$major_trans_2020<-as.factor(regressor$major_trans_2020)
regressor$major_trans_2020<-relevel(regressor$major_trans_2020,ref = "other")

regressor <- regressor %>%
  mutate(
    # 1) if P13 not NA, take P13, otherwise keep original P14
    occupation = if_else(!is.na(P13), as.character(P13), as.character(occupation)),
    # 2) if P15 not NA, paste it to the (possibly updated) P14; else leave as is
    occupation = if_else(
      !is.na(P15),
      paste(occupation, P15, sep = " / "),  # use whatever separator you like
      occupation
    )
  )
regressor$occupation <- str_remove_all(regressor$occupation, "(^NA\\s*/\\s*)|(\\s*/\\s*NA$)")

regressor<-regressor%>%
  mutate(occupation= as.numeric(occupation)) %>%
  select(-P13, -P15)

regressor<-regressor%>%
  mutate(occupation= case_when(
    occupation %in% c(1,2,3,4,5,22) ~ "student",
    occupation %in% c(11,12) ~ "employed",
    occupation %in% c(13,14,15,16) ~ "self-employed",
    occupation %in% c(6,7,8,9,17) ~ "informal",
    occupation == 97 ~ "NA",
    TRUE ~ "Other-unemployed"
  ))
regressor$occupation <- as.factor(regressor$occupation)
regressor$occupation <- relevel(regressor$occupation, ref = "Other-unemployed") # Relevel to set the reference category

regressor<-regressor%>%
  mutate(income= case_when(
    income %in% c(1,2,3) ~ "Low",
    income %in% c(4,5,6) ~ "lower-mid",
    income %in% c(7,8) ~ "Upper-mid",
    income %in% c(9,10,11) ~ "High",
    TRUE ~ "Other"
    ))%>%
  mutate(income = as.factor(income))
regressor$income <- relevel(regressor$income, ref = "Other") # Relevel to set the reference category

regressor<-regressor%>%
  mutate(live_time= case_when(
    live_time %in% c(1,2) ~ "short",
    live_time %in% c(3,4) ~ "medium",
    live_time %in% c(5,6) ~ "long",
    TRUE ~ "NA"
  )) %>%
  mutate(live_time = as.factor(live_time))

regressor$live_time <- relevel(regressor$live_time, ref = "medium") # Relevel to set the reference category

regressor <- regressor %>%
  mutate(
    age = if_else(
      age %in% c(1,2),
      "under_18",
      as.character(age)      # keeps the original age for everyone else
    )
  )%>%
  mutate(age = as.factor(age))



model_house<-multinom(P87~.,data=regressor)

z<-summary(model_house)$coefficients/summary(model_house)$standard.errors
p_values<- (1 - pnorm(abs(z), 0, 1)) * 2

# 1. grab raw summary
s       <- summary(model_house)
coef_mat<- s$coefficients
se_mat  <- s$standard.errors

# 2. compute z-scores & p-values
z_mat <- coef_mat / se_mat
p_mat <- 2 * pnorm(-abs(z_mat))

# 3. pivot to long form
df_coef <- as.data.frame(coef_mat) %>%
  rownames_to_column("Outcome") %>%
  pivot_longer(-Outcome, names_to="Predictor", values_to="Coef")
df_se   <- as.data.frame(se_mat) %>%
  rownames_to_column("Outcome") %>%
  pivot_longer(-Outcome, names_to="Predictor", values_to="SE")
df_z    <- as.data.frame(z_mat) %>%
  rownames_to_column("Outcome") %>%
  pivot_longer(-Outcome, names_to="Predictor", values_to="z")
df_p    <- as.data.frame(p_mat) %>%
  rownames_to_column("Outcome") %>%
  pivot_longer(-Outcome, names_to="Predictor", values_to="p.value")

# 4. join and format, adding stars
results <- df_coef %>%
  left_join(df_se, by=c("Outcome","Predictor")) %>%
  left_join(df_z,  by=c("Outcome","Predictor")) %>%
  left_join(df_p,  by=c("Outcome","Predictor")) %>%
  mutate(
    OR      = exp(Coef),
    across(c(Coef, SE, z, OR, p.value), ~ round(., 3)),
    stars   = case_when(
      p.value < 0.001 ~ "***",
      p.value < 0.01  ~ "**",
      p.value < 0.05  ~ "*",
      TRUE            ~ ""
    ),
    OR       = paste0(OR, stars)
  ) %>%
  select(Outcome, Predictor, OR, Coef, SE, z, p.value)

# 5. render as styled HTML
kable(
  results,
  format     = "html",
  table.attr = 'class="table table-striped"',
  col.names  = c("Outcome", "Predictor", "OR", "Coef", "SE", "z-score", "p-value"),
  caption    = "Multinomial logit: Odds Ratios (with significance), Coefs, SEs, z-scores & p-values"
) %>%
  kable_styling(
    bootstrap_options = c("striped", "hover", "condensed", "responsive"),
    full_width        = FALSE
  )
```

### Results

#### **significant factor (variables) in choice one (increase) vs choice two (not change)**:

- **population number** (`P3`): For every one additional person in household, the odds responding "increase" rather than "not change" are 0.824 times greater -- or in other words, the odds of responding "increase" than "no change" **decrease by 17.6% for every additional person in the household,** with holding other variables constant.
*For every 1 additional person in household, the log-odds of responding "increase" rather than "not change" increase by 0.4, with holding other variables constant.*
- **educational attainment_technology** (`P12`): The log-odds of responding "increase" rather than "not change" are 0.58 higher for people with a technological education compared to those with upper secondary education, with holding other variables constant. In other words, **people with a technological education have 78.6% higher odds of choosing "increase" than "not change" compared to people with upper secondary education, with holding other variables constant.**
- **income_high** (`P50`): The log-odds of responding "increase" rather than "not change" are 0.65 lower for people with high income compared to those with not report their income, with holding other variables constant. In other words, **people with high income have 47.8% lower odds of choosing "increase" than "not change" compared to people with not report their income, with holding other variables constant.**
- **major_transportation_mode before 2020_walk** (`P42`): The log-odds of responding "increase" rather than "not change" are 0.622 higher for people who walk as their major transportation mode before 2020 compared to those who use other transportation modes (not major), with holding other variables constant. In other words, **people who walk as their major transportation mode before 2020 have 86.2% lower odds of choosing "increase" than "not change" compared to people who use other transportation modes, with holding other variables constant.**
- **age_under18** (`Edad`): Although the young population is also statistically significant, I am hesitate to include this as reliable predictors since we join the person data to household data, if household answer they prefer the choice metro is make the housing value higher, then their kids corresponding results share the same way. It's not meaningful as the data nature of children do not answer this question individually.**Question: should we suggests that family with young kids tend to prefer the statement that the metro will increase the housing value?**
- **rent_own_2** (`P82`): The log-odds of responding "increase" rather than "not change" are 0.432 lower for people who rent than those who own their home, with holding other variables constant. In other words, **renter have 35.1% lower odds of choosing "increase" than "not change" compared to people who own their home, with holding other variables constant.**
- **live_time_long** (`P83`): The log-odds of responding "increase" rather than "not change" are 0.414 higher for people who have lived in their current home for a long time compared to those who have lived in their current home for a medium time, with holding other variables constant. In other words, **people who have lived in their current home for a long time have 51.2% higher odds of choosing "increase" than "not change" compared to people who have lived in their current home for a medium time, with holding other variables constant.**

#### **significant factor (variables) in choice three (decrease) vs choice two (not change)**:

- **income_low** (`P50`): The log-odds of responding "decrease" rather than "not change" are 2.109 higher for people with low income compared to those with not report their income, with holding other variables constant. In other words, **people with low income have 724% higher odds of choosing "decrease" than "not change" compared to people with not report their income, with holding other variables constant.**  (*Potential concerning as the log-odds is very high, indicating that the sample size of this category is too small to draw any conclusion.*)
- **live_time_long** (`P83`): The log-odds of responding "decrease" rather than "not change" are 1.099 lower for people who have lived in their current home for a long time compared to those who have lived in their current home for a medium time, with holding other variables constant. In other words, **people who have lived in their current home for a long time have 66.7% lower odds of choosing "decrease" than "not change" compared to people who have lived in their current home for a medium time, with holding other variables constant.**

## P90: Safety in the neighborhood

### Question:
We would like to know your perception of the possible impacts of the First and Second Line of the Bogotá Metro once it is inaugurated and in operation. Please indicate your perception of each of the following statements:

**Safety in the neighborhood.**

### Potential Answers:
- 1: It will increase
- 2: Will be maintained
- 3: It will decrease

```{r}
trips <- readRDS("data/008-24 BBDD Procesamiento Etapas.rds")
hog <- readRDS("data/008-24 BBDD Procesamiento Hogares.rds")
per <- readRDS("data/008-24 BBDD Procesamiento Personas.rds")

per_complt <- per %>%
  left_join(hog,by="ID_Hogar")

dependent_variable<- "P90"
independent_variables <- c("P3", "P42",
                           "P50", "P12", "P14",
                           "Edad", "P10", "P12","P13","P15", "P14", "P82", "P83")

regressor<- per_complt %>%
  select(all_of(dependent_variable), all_of(independent_variables))


regressor <- regressor %>%
  mutate(
    across(
      where(is.labelled),    # pick all haven_labelled columns
      ~ zap_labels(.)        # strip off the labels, leaving the underlying numeric
    )
  )
regressor$P90 <- as.factor(regressor$P90)
regressor$P90<-relevel(regressor$P90, ref = "2") # Relevel to set the reference category

regressor<-regressor%>%
  rename(pop_num=P3,
         major_trans_2020=P42,
         income= P50,
         rent_own= P82,
         live_time= P83
         )

regressor<-regressor%>%
  rename(edu_att= P12,
         occupation= P14,
         gender= P10,
         age= Edad
         )

regressor$rent_own<- as.factor(regressor$rent_own) # own =1, rent =2
regressor$rent_own <- relevel(regressor$rent_own, ref = "1") # Relevel to set the reference category
regressor$gender <- as.factor(regressor$gender) #female =1, male=2
regressor$gender <- relevel(regressor$gender, ref = "2") # Relevel to set the reference category


regressor$edu_att <- dplyr::case_when(
  regressor$edu_att %in% c(1, 2, 3) ~ "Primary",
  regressor$edu_att %in% c(4, 5) ~ "LowerSecondary",
  regressor$edu_att %in% c(6, 7) ~ "UpperSecondary",
  regressor$edu_att %in% c(8, 9) ~ "Technological",
  regressor$edu_att %in% c(10, 11, 12, 13) ~ "University",
  regressor$edu_att == 97 ~ "NA",
)
regressor$edu_att <- as.factor(regressor$edu_att)
regressor$edu_att <- relevel(regressor$edu_att, ref = "UpperSecondary") # Relevel to set the reference category

regressor<-regressor %>%
  mutate(major_trans_2020= case_when(
    major_trans_2020 %in% c(1,2,3,4,5,6,10,16) ~ "public_tansit",
    major_trans_2020 %in% c(7,8,9) ~ "informal",
    major_trans_2020 %in% c(11,12) ~ "taxi",
    major_trans_2020 %in% c(22,23) ~ "personal_veh",
    major_trans_2020 %in% c(24,25) ~"motorcyle",
    major_trans_2020 %in% c(25,27,28,17) ~ "bicycle",
    major_trans_2020==34 ~ "walking",
    TRUE ~ "other"
))
regressor$major_trans_2020<-as.factor(regressor$major_trans_2020)
regressor$major_trans_2020<-relevel(regressor$major_trans_2020,ref = "other")

regressor <- regressor %>%
  mutate(
    # 1) if P13 not NA, take P13, otherwise keep original P14
    occupation = if_else(!is.na(P13), as.character(P13), as.character(occupation)),
    # 2) if P15 not NA, paste it to the (possibly updated) P14; else leave as is
    occupation = if_else(
      !is.na(P15),
      paste(occupation, P15, sep = " / "),  # use whatever separator you like
      occupation
    )
  )
regressor$occupation <- str_remove_all(regressor$occupation, "(^NA\\s*/\\s*)|(\\s*/\\s*NA$)")

regressor<-regressor%>%
  mutate(occupation= as.numeric(occupation)) %>%
  select(-P13, -P15)

regressor<-regressor%>%
  mutate(occupation= case_when(
    occupation %in% c(1,2,3,4,5,22) ~ "student",
    occupation %in% c(11,12) ~ "employed",
    occupation %in% c(13,14,15,16) ~ "self-employed",
    occupation %in% c(6,7,8,9,17) ~ "informal",
    occupation == 97 ~ "NA",
    TRUE ~ "Other-unemployed"
  ))
regressor$occupation <- as.factor(regressor$occupation)
regressor$occupation <- relevel(regressor$occupation, ref = "Other-unemployed") # Relevel to set the reference category

regressor<-regressor%>%
  mutate(income= case_when(
    income %in% c(1,2,3) ~ "Low",
    income %in% c(4,5,6) ~ "lower-mid",
    income %in% c(7,8) ~ "Upper-mid",
    income %in% c(9,10,11) ~ "High",
    TRUE ~ "Other"
    ))%>%
  mutate(income = as.factor(income))
regressor$income <- relevel(regressor$income, ref = "Other") # Relevel to set the reference category

regressor<-regressor%>%
  mutate(live_time= case_when(
    live_time %in% c(1,2) ~ "short",
    live_time %in% c(3,4) ~ "medium",
    live_time %in% c(5,6) ~ "long",
    TRUE ~ "NA"
  )) %>%
  mutate(live_time = as.factor(live_time))

regressor$live_time <- relevel(regressor$live_time, ref = "medium") # Relevel to set the reference category

regressor <- regressor %>%
  mutate(
    age = if_else(
      age %in% c(1,2),
      "under_18",
      as.character(age)      # keeps the original age for everyone else
    )
  )%>%
  mutate(age = as.factor(age))



model_house<-multinom(P90~.,data=regressor)

z<-summary(model_house)$coefficients/summary(model_house)$standard.errors
p_values<- (1 - pnorm(abs(z), 0, 1)) * 2

# 1. grab raw summary
s       <- summary(model_house)
coef_mat<- s$coefficients
se_mat  <- s$standard.errors

# 2. compute z-scores & p-values
z_mat <- coef_mat / se_mat
p_mat <- 2 * pnorm(-abs(z_mat))

# 3. pivot to long form
df_coef <- as.data.frame(coef_mat) %>%
  rownames_to_column("Outcome") %>%
  pivot_longer(-Outcome, names_to="Predictor", values_to="Coef")
df_se   <- as.data.frame(se_mat) %>%
  rownames_to_column("Outcome") %>%
  pivot_longer(-Outcome, names_to="Predictor", values_to="SE")
df_z    <- as.data.frame(z_mat) %>%
  rownames_to_column("Outcome") %>%
  pivot_longer(-Outcome, names_to="Predictor", values_to="z")
df_p    <- as.data.frame(p_mat) %>%
  rownames_to_column("Outcome") %>%
  pivot_longer(-Outcome, names_to="Predictor", values_to="p.value")

# 4. join and format, adding stars
results <- df_coef %>%
  left_join(df_se, by=c("Outcome","Predictor")) %>%
  left_join(df_z,  by=c("Outcome","Predictor")) %>%
  left_join(df_p,  by=c("Outcome","Predictor")) %>%
  mutate(
    OR      = exp(Coef),
    across(c(Coef, SE, z, OR, p.value), ~ round(., 3)),
    stars   = case_when(
      p.value < 0.001 ~ "***",
      p.value < 0.01  ~ "**",
      p.value < 0.05  ~ "*",
      TRUE            ~ ""
    ),
    OR       = paste0(OR, stars)
  ) %>%
  select(Outcome, Predictor, OR, Coef, SE, z, p.value)

# 5. render as styled HTML
kable(
  results,
  format     = "html",
  table.attr = 'class="table table-striped"',
  col.names  = c("Outcome", "Predictor", "OR", "Coef", "SE", "z-score", "p-value"),
  caption    = "Multinomial logit: Odds Ratios (with significance), Coefs, SEs, z-scores & p-values"
) %>%
  kable_styling(
    bootstrap_options = c("striped", "hover", "condensed", "responsive"),
    full_width        = FALSE
  )
```

### Results

#### **significant factor (variables) in choice one (increase) vs choice two (not change)**:

- **personal vehicle** (`P42`): People who use personal vehicle as their major transportation mode before 2020 have 64% lower odds of choosing "increase" than "not change" compared to people who use other transportation modes, with holding other variables constant.
- **public transit** (`P42`): People who use public transit as their major transportation mode before 2020 have 36% lower odds of choosing "increase" than "not change" compared to people who use other transportation modes, with holding other variables constant.
- **taxi** (`P42`): People who use taxi as their major transportation mode before 2020 have 59.8% lower odds of choosing "increase" than "not change" compared to people who use other transportation modes, with holding other variables constant.
- **walk** (`P42`): People who walk as their major transportation mode before 2020 have 55.9% lower odds of choosing "increase" than "not change" compared to people who use other transportation modes, with holding other variables constant.
- **income_high** (`P50`): People with high income have 2.9 times higher odds of choosing "increase" than "not change" compared to people with not report their income, with holding other variables constant. (*highly significant, may cause by unproper reference or small sample size*)

#### **significant factor (variables) in choice three (decrease) vs choice two (not change)**:

- **personal vehicle** (`P42`): People who use personal vehicle as their major transportation mode before 2020 have 75.3% lower odds of choosing "decrease" than "not change" compared to people who use other transportation modes, with holding other variables constant. (*Since both "decrease" and "increased" are negative, this means that people who use personal vehicle as their major transportation mode before 2020 are likely to choose "not change" than change compared to people who use other transportation modes. further reference category need to choose to further examine the hypothesis*)
-**walking** (`P42`): People who walk as their major transportation mode before 2020 have 59.8% lower odds of choosing "decrease" than "not change" compared to people who use other transportation modes, with holding other variables constant.(Note: similar to personal vehicle).
- **income_high** (`P50`): People with high income have 2.39 times higher odds of choosing "decrease" than "not change" compared to people with not report their income, with holding other variables constant. (*same direction than previous*)
- **income_low** (`P50`): People with low income have 55.9% lower odds of choosing "decrease" than "not change" compared to people with not report their income, with holding other variables constant. (*highly significant, may cause by unproper reference or small sample size*)
- **edu_lower secondary** (`P12`): People with lower secondary education have 53% lower odds of choosing "decrease" than "not change" compared to people with upper secondary education, with holding other variables constant. 
- **edu_primary** (`P12`): People with primary education have 51.7% lower odds of choosing "decrease" than "not change" compared to people with upper secondary education, with holding other variables constant. 
- **occupation -employed** (`P14`): People who are employed (formal job) have 47.2% lower odds of choosing "decrease" than "not change" compared to people who are unemployed, with holding other variables constant. 
- **age_under 18** (`Edad`): People who are under 18 years old have 1.7 times higher odds of choosing "decrease" than "not change" compared to people who are over 65 years old, with holding other variables constant. (*data structure uncertain*)


## P91: Cost of living

### Question:

**Statement : Cost of living in the neighborhood.**

### Potential Answers:
- 1: It will increase
- 2: Will be maintained
- 3: It will decrease

```{r, warning= FALSE}
trips <- readRDS("data/008-24 BBDD Procesamiento Etapas.rds")
hog <- readRDS("data/008-24 BBDD Procesamiento Hogares.rds")
per <- readRDS("data/008-24 BBDD Procesamiento Personas.rds")

per_complt <- per %>%
  left_join(hog,by="ID_Hogar")

dependent_variable<- "P91"
independent_variables <- c("P3", "P42",
                           "P50", "P12", "P14",
                           "Edad", "P10", "P12","P13","P15", "P14", "P82", "P83")

regressor<- per_complt %>%
  select(all_of(dependent_variable), all_of(independent_variables))


regressor <- regressor %>%
  mutate(
    across(
      where(is.labelled),    # pick all haven_labelled columns
      ~ zap_labels(.)        # strip off the labels, leaving the underlying numeric
    )
  )
regressor$P91 <- as.factor(regressor$P91)
regressor$P91<-relevel(regressor$P91, ref = "2") # Relevel to set the reference category

regressor<-regressor%>%
  rename(pop_num=P3,
         major_trans_2020=P42,
         income= P50,
         rent_own= P82,
         live_time= P83
         )

regressor<-regressor%>%
  rename(edu_att= P12,
         occupation= P14,
         gender= P10,
         age= Edad
         )

regressor$rent_own<- as.factor(regressor$rent_own) # own =1, rent =2
regressor$rent_own <- relevel(regressor$rent_own, ref = "1") # Relevel to set the reference category
regressor$gender <- as.factor(regressor$gender) #female =1, male=2
regressor$gender <- relevel(regressor$gender, ref = "2") # Relevel to set the reference category


regressor$edu_att <- dplyr::case_when(
  regressor$edu_att %in% c(1, 2, 3) ~ "Primary",
  regressor$edu_att %in% c(4, 5) ~ "LowerSecondary",
  regressor$edu_att %in% c(6, 7) ~ "UpperSecondary",
  regressor$edu_att %in% c(8, 9) ~ "Technological",
  regressor$edu_att %in% c(10, 11, 12, 13) ~ "University",
  regressor$edu_att == 97 ~ "NA",
)
regressor$edu_att <- as.factor(regressor$edu_att)
regressor$edu_att <- relevel(regressor$edu_att, ref = "UpperSecondary") # Relevel to set the reference category

regressor<-regressor %>%
  mutate(major_trans_2020= case_when(
    major_trans_2020 %in% c(1,2,3,4,5,6,10,16) ~ "public_tansit",
    major_trans_2020 %in% c(7,8,9) ~ "informal",
    major_trans_2020 %in% c(11,12) ~ "taxi",
    major_trans_2020 %in% c(22,23) ~ "personal_veh",
    major_trans_2020 %in% c(24,25) ~"motorcyle",
    major_trans_2020 %in% c(25,27,28,17) ~ "bicycle",
    major_trans_2020==34 ~ "walking",
    TRUE ~ "other"
))
regressor$major_trans_2020<-as.factor(regressor$major_trans_2020)
regressor$major_trans_2020<-relevel(regressor$major_trans_2020,ref = "other")

regressor <- regressor %>%
  mutate(
    # 1) if P13 not NA, take P13, otherwise keep original P14
    occupation = if_else(!is.na(P13), as.character(P13), as.character(occupation)),
    # 2) if P15 not NA, paste it to the (possibly updated) P14; else leave as is
    occupation = if_else(
      !is.na(P15),
      paste(occupation, P15, sep = " / "),  # use whatever separator you like
      occupation
    )
  )
regressor$occupation <- str_remove_all(regressor$occupation, "(^NA\\s*/\\s*)|(\\s*/\\s*NA$)")

regressor<-regressor%>%
  mutate(occupation= as.numeric(occupation)) %>%
  select(-P13, -P15)

regressor<-regressor%>%
  mutate(occupation= case_when(
    occupation %in% c(1,2,3,4,5,22) ~ "student",
    occupation %in% c(11,12) ~ "employed",
    occupation %in% c(13,14,15,16) ~ "self-employed",
    occupation %in% c(6,7,8,9,17) ~ "informal",
    occupation == 97 ~ "NA",
    TRUE ~ "Other-unemployed"
  ))
regressor$occupation <- as.factor(regressor$occupation)
regressor$occupation <- relevel(regressor$occupation, ref = "Other-unemployed") # Relevel to set the reference category

regressor<-regressor%>%
  mutate(income= case_when(
    income %in% c(1,2,3) ~ "Low",
    income %in% c(4,5,6) ~ "lower-mid",
    income %in% c(7,8) ~ "Upper-mid",
    income %in% c(9,10,11) ~ "High",
    TRUE ~ "Other"
    ))%>%
  mutate(income = as.factor(income))
regressor$income <- relevel(regressor$income, ref = "Other") # Relevel to set the reference category

regressor<-regressor%>%
  mutate(live_time= case_when(
    live_time %in% c(1,2) ~ "short",
    live_time %in% c(3,4) ~ "medium",
    live_time %in% c(5,6) ~ "long",
    TRUE ~ "NA"
  )) %>%
  mutate(live_time = as.factor(live_time))

regressor$live_time <- relevel(regressor$live_time, ref = "medium") # Relevel to set the reference category

regressor <- regressor %>%
  mutate(
    age = if_else(
      age %in% c(1,2),
      "under_18",
      as.character(age)      # keeps the original age for everyone else
    )
  )%>%
  mutate(age = as.factor(age))



model_house<-multinom(P91~.,data=regressor)

z<-summary(model_house)$coefficients/summary(model_house)$standard.errors
p_values<- (1 - pnorm(abs(z), 0, 1)) * 2

# 1. grab raw summary
s       <- summary(model_house)
coef_mat<- s$coefficients
se_mat  <- s$standard.errors

# 2. compute z-scores & p-values
z_mat <- coef_mat / se_mat
p_mat <- 2 * pnorm(-abs(z_mat))

# 3. pivot to long form
df_coef <- as.data.frame(coef_mat) %>%
  rownames_to_column("Outcome") %>%
  pivot_longer(-Outcome, names_to="Predictor", values_to="Coef")
df_se   <- as.data.frame(se_mat) %>%
  rownames_to_column("Outcome") %>%
  pivot_longer(-Outcome, names_to="Predictor", values_to="SE")
df_z    <- as.data.frame(z_mat) %>%
  rownames_to_column("Outcome") %>%
  pivot_longer(-Outcome, names_to="Predictor", values_to="z")
df_p    <- as.data.frame(p_mat) %>%
  rownames_to_column("Outcome") %>%
  pivot_longer(-Outcome, names_to="Predictor", values_to="p.value")

# 4. join and format, adding stars
results <- df_coef %>%
  left_join(df_se, by=c("Outcome","Predictor")) %>%
  left_join(df_z,  by=c("Outcome","Predictor")) %>%
  left_join(df_p,  by=c("Outcome","Predictor")) %>%
  mutate(
    OR      = exp(Coef),
    across(c(Coef, SE, z, OR, p.value), ~ round(., 3)),
    stars   = case_when(
      p.value < 0.001 ~ "***",
      p.value < 0.01  ~ "**",
      p.value < 0.05  ~ "*",
      TRUE            ~ ""
    ),
    OR       = paste0(OR, stars)
  ) %>%
  select(Outcome, Predictor, OR, Coef, SE, z, p.value)

# 5. render as styled HTML
kable(
  results,
  format     = "html",
  table.attr = 'class="table table-striped"',
  col.names  = c("Outcome", "Predictor", "OR", "Coef", "SE", "z-score", "p-value"),
  caption    = "Multinomial logit: Odds Ratios (with significance), Coefs, SEs, z-scores & p-values"
) %>%
  kable_styling(
    bootstrap_options = c("striped", "hover", "condensed", "responsive"),
    full_width        = FALSE
  )
```

### Results

#### **significant factor (variables) in choice one (increase) vs choice two (not change)**:

- **public transit** (`P42`): People who use public transit as their major transportation mode before 2020 have 52.5% higher odds of choosing "increase" than "not change" compared to people who use other transportation modes, with holding other variables constant.
- **personal vehicle** (`P42`): People who use personal vehicle as their major transportation mode before 2020 have 50% lower odds of choosing "increase" than "not change" compared to people who use other transportation modes, with holding other variables constant.
- **taxi** (`P42`): People who use taxi as their major transportation mode before 2020 have 84% lower odds of choosing "increase" than "not change" compared to people who use other transportation modes, with holding other variables constant.
- **income high** (`P50`): People with high income have 6 times higher odds of choosing "increase" than "not change" compared to people with not report their income, with holding other variables constant. (*highly significant, may cause by unproper reference or small sample size*)
- **income low-mid** (`P50`): People with low-mid income have 94.8% higher odds of choosing "increase" than "not change" compared to people with not report their income, with holding other variables constant. 
- **income upper-mid** (`P50`): People with upper-mid income have 80.5% higher odds of choosing "increase" than "not change" compared to people with not report their income, with holding other variables constant.
- **live time long** (`P83`): People who have lived in their current home for a long time have 53.9% higher odds of choosing "increase" than "not change" compared to people who have lived in their current home for a medium time, with holding other variables constant.

#### **significant factor (variables) in choice three (decrease) vs choice two (not change)**:

- **income upper-mid** (`P50`): People with upper-mid income have 86.2% lower odds of choosing "decrease" than "not change" compared to people with not report their income, with holding other variables constant. 

## P92: Local commerce

### Question:

**Statement: Local commerce (formal and informal).**

### Potential Answers:
- 1: It will increase
- 2: Will be maintained
- 3: It will decrease


```{r}
trips <- readRDS("data/008-24 BBDD Procesamiento Etapas.rds")
hog <- readRDS("data/008-24 BBDD Procesamiento Hogares.rds")
per <- readRDS("data/008-24 BBDD Procesamiento Personas.rds")

per_complt <- per %>%
  left_join(hog,by="ID_Hogar")

dependent_variable<- "P92"
independent_variables <- c("P3", "P42",
                           "P50", "P12", "P14",
                           "Edad", "P10", "P12","P13","P15", "P14", "P82", "P83")

regressor<- per_complt %>%
  select(all_of(dependent_variable), all_of(independent_variables))


regressor <- regressor %>%
  mutate(
    across(
      where(is.labelled),    # pick all haven_labelled columns
      ~ zap_labels(.)        # strip off the labels, leaving the underlying numeric
    )
  )
regressor$P92 <- as.factor(regressor$P92)
regressor$P92<-relevel(regressor$P92, ref = "2") # Relevel to set the reference category

regressor<-regressor%>%
  rename(pop_num=P3,
         major_trans_2020=P42,
         income= P50,
         rent_own= P82,
         live_time= P83
         )

regressor<-regressor%>%
  rename(edu_att= P12,
         occupation= P14,
         gender= P10,
         age= Edad
         )


regressor$rent_own<- as.factor(regressor$rent_own) # own =1, rent =2
regressor$rent_own <- relevel(regressor$rent_own, ref = "1") # Relevel to set the reference category
regressor$gender <- as.factor(regressor$gender) #female =1, male=2
regressor$gender <- relevel(regressor$gender, ref = "2") # Relevel to set the reference category


regressor$edu_att <- dplyr::case_when(
  regressor$edu_att %in% c(1, 2, 3) ~ "Primary",
  regressor$edu_att %in% c(4, 5) ~ "LowerSecondary",
  regressor$edu_att %in% c(6, 7) ~ "UpperSecondary",
  regressor$edu_att %in% c(8, 9) ~ "Technological",
  regressor$edu_att %in% c(10, 11, 12, 13) ~ "University",
  regressor$edu_att == 97 ~ "NA",
)
regressor$edu_att <- as.factor(regressor$edu_att)
regressor$edu_att <- relevel(regressor$edu_att, ref = "UpperSecondary") # Relevel to set the reference category

regressor<-regressor %>%
  mutate(major_trans_2020= case_when(
    major_trans_2020 %in% c(1,2,3,4,5,6,10,16) ~ "public_tansit",
    major_trans_2020 %in% c(7,8,9) ~ "informal",
    major_trans_2020 %in% c(11,12) ~ "taxi",
    major_trans_2020 %in% c(22,23) ~ "personal_veh",
    major_trans_2020 %in% c(24,25) ~"motorcyle",
    major_trans_2020 %in% c(25,27,28,17) ~ "bicycle",
    major_trans_2020==34 ~ "walking",
    TRUE ~ "other"
))
regressor$major_trans_2020<-as.factor(regressor$major_trans_2020)
regressor$major_trans_2020<-relevel(regressor$major_trans_2020,ref = "other")

regressor <- regressor %>%
  mutate(
    # 1) if P13 not NA, take P13, otherwise keep original P14
    occupation = if_else(!is.na(P13), as.character(P13), as.character(occupation)),
    # 2) if P15 not NA, paste it to the (possibly updated) P14; else leave as is
    occupation = if_else(
      !is.na(P15),
      paste(occupation, P15, sep = " / "),  # use whatever separator you like
      occupation
    )
  )
regressor$occupation <- str_remove_all(regressor$occupation, "(^NA\\s*/\\s*)|(\\s*/\\s*NA$)")

regressor<-regressor%>%
  mutate(occupation= as.numeric(occupation)) %>%
  select(-P13, -P15)

regressor<-regressor%>%
  mutate(occupation= case_when(
    occupation %in% c(1,2,3,4,5,22) ~ "student",
    occupation %in% c(11,12) ~ "employed",
    occupation %in% c(13,14,15,16) ~ "self-employed",
    occupation %in% c(6,7,8,9,17) ~ "informal",
    occupation == 97 ~ "NA",
    TRUE ~ "Other-unemployed"
  ))
regressor$occupation <- as.factor(regressor$occupation)
regressor$occupation <- relevel(regressor$occupation, ref = "Other-unemployed") # Relevel to set the reference category

regressor<-regressor%>%
  mutate(income= case_when(
    income %in% c(1,2,3) ~ "Low",
    income %in% c(4,5,6) ~ "lower-mid",
    income %in% c(7,8) ~ "Upper-mid",
    income %in% c(9,10,11) ~ "High",
    TRUE ~ "Other"
    ))%>%
  mutate(income = as.factor(income))
regressor$income <- relevel(regressor$income, ref = "Other") # Relevel to set the reference category

regressor<-regressor%>%
  mutate(live_time= case_when(
    live_time %in% c(1,2) ~ "short",
    live_time %in% c(3,4) ~ "medium",
    live_time %in% c(5,6) ~ "long",
    TRUE ~ "NA"
  )) %>%
  mutate(live_time = as.factor(live_time))

regressor$live_time <- relevel(regressor$live_time, ref = "medium") # Relevel to set the reference category

regressor <- regressor %>%
  mutate(
    age = if_else(
      age %in% c(1,2),
      "under_18",
      as.character(age)      # keeps the original age for everyone else
    )
  )%>%
  mutate(age = as.factor(age))



model_house<-multinom(P92~.,data=regressor)

z<-summary(model_house)$coefficients/summary(model_house)$standard.errors
p_values<- (1 - pnorm(abs(z), 0, 1)) * 2

# 1. grab raw summary
s       <- summary(model_house)
coef_mat<- s$coefficients
se_mat  <- s$standard.errors

# 2. compute z-scores & p-values
z_mat <- coef_mat / se_mat
p_mat <- 2 * pnorm(-abs(z_mat))

# 3. pivot to long form
df_coef <- as.data.frame(coef_mat) %>%
  rownames_to_column("Outcome") %>%
  pivot_longer(-Outcome, names_to="Predictor", values_to="Coef")
df_se   <- as.data.frame(se_mat) %>%
  rownames_to_column("Outcome") %>%
  pivot_longer(-Outcome, names_to="Predictor", values_to="SE")
df_z    <- as.data.frame(z_mat) %>%
  rownames_to_column("Outcome") %>%
  pivot_longer(-Outcome, names_to="Predictor", values_to="z")
df_p    <- as.data.frame(p_mat) %>%
  rownames_to_column("Outcome") %>%
  pivot_longer(-Outcome, names_to="Predictor", values_to="p.value")

# 4. join and format, adding stars
results <- df_coef %>%
  left_join(df_se, by=c("Outcome","Predictor")) %>%
  left_join(df_z,  by=c("Outcome","Predictor")) %>%
  left_join(df_p,  by=c("Outcome","Predictor")) %>%
  mutate(
    OR      = exp(Coef),
    across(c(Coef, SE, z, OR, p.value), ~ round(., 3)),
    stars   = case_when(
      p.value < 0.001 ~ "***",
      p.value < 0.01  ~ "**",
      p.value < 0.05  ~ "*",
      TRUE            ~ ""
    ),
    OR       = paste0(OR, stars)
  ) %>%
  select(Outcome, Predictor, OR, Coef, SE, z, p.value)

# 5. render as styled HTML
kable(
  results,
  format     = "html",
  table.attr = 'class="table table-striped"',
  col.names  = c("Outcome", "Predictor", "OR", "Coef", "SE", "z-score", "p-value"),
  caption    = "Multinomial logit: Odds Ratios (with significance), Coefs, SEs, z-scores & p-values"
) %>%
  kable_styling(
    bootstrap_options = c("striped", "hover", "condensed", "responsive"),
    full_width        = FALSE
  )
```

### Results

#### **significant factor (variables) in choice one (increase) vs choice two (not change)**:


## P95: Satisfaction with public transportation

### Question:

**Statement: Satisfaction with public transportation.**

### Potential Answers:
- 1: will be increased
- 2: will be maintained
- 3: will be decreased

```{r}
trips <- readRDS("data/008-24 BBDD Procesamiento Etapas.rds")
hog <- readRDS("data/008-24 BBDD Procesamiento Hogares.rds")
per <- readRDS("data/008-24 BBDD Procesamiento Personas.rds")

per_complt <- per %>%
  left_join(hog,by="ID_Hogar")

dependent_variable<- "P95"
independent_variables <- c("P3", "P42",
                           "P50", "P12", "P14",
                           "Edad", "P10", "P12","P13","P15", "P14", "P82", "P83")

regressor<- per_complt %>%
  select(all_of(dependent_variable), all_of(independent_variables))


regressor <- regressor %>%
  mutate(
    across(
      where(is.labelled),    # pick all haven_labelled columns
      ~ zap_labels(.)        # strip off the labels, leaving the underlying numeric
    )
  )
regressor$P95 <- as.factor(regressor$P95)
regressor$P95 <- relevel(regressor$P95, ref = "2") # Relevel to set the reference category

regressor<-regressor%>%
  rename(pop_num=P3,
         major_trans_2020=P42,
         income= P50,
         rent_own= P82,
         live_time= P83
         )

regressor<-regressor%>%
  rename(edu_att= P12,
         occupation= P14,
         gender= P10,
         age= Edad
         )

regressor$rent_own<- as.factor(regressor$rent_own) # own =1, rent =2
regressor$rent_own <- relevel(regressor$rent_own, ref = "1") # Relevel to set the reference category
regressor$gender <- as.factor(regressor$gender) #female =1, male=2
regressor$gender <- relevel(regressor$gender, ref = "2") # Relevel to set the reference category


regressor$edu_att <- dplyr::case_when(
  regressor$edu_att %in% c(1, 2, 3) ~ "Primary",
  regressor$edu_att %in% c(4, 5) ~ "LowerSecondary",
  regressor$edu_att %in% c(6, 7) ~ "UpperSecondary",
  regressor$edu_att %in% c(8, 9) ~ "Technological",
  regressor$edu_att %in% c(10, 11, 12, 13) ~ "University",
  regressor$edu_att == 97 ~ "NA",
)
regressor$edu_att <- as.factor(regressor$edu_att)
regressor$edu_att <- relevel(regressor$edu_att, ref = "UpperSecondary") # Relevel to set the reference category

regressor<-regressor %>%
  mutate(major_trans_2020= case_when(
    major_trans_2020 %in% c(1,2,3,4,5,6,10,16) ~ "public_tansit",
    major_trans_2020 %in% c(7,8,9) ~ "informal",
    major_trans_2020 %in% c(11,12) ~ "taxi",
    major_trans_2020 %in% c(22,23) ~ "personal_veh",
    major_trans_2020 %in% c(24,25) ~"motorcyle",
    major_trans_2020 %in% c(25,27,28,17) ~ "bicycle",
    major_trans_2020==34 ~ "walking",
    TRUE ~ "other"
))
regressor$major_trans_2020<-as.factor(regressor$major_trans_2020)
regressor$major_trans_2020<-relevel(regressor$major_trans_2020,ref = "other")

regressor <- regressor %>%
  mutate(
    # 1) if P13 not NA, take P13, otherwise keep original P14
    occupation = if_else(!is.na(P13), as.character(P13), as.character(occupation)),
    # 2) if P15 not NA, paste it to the (possibly updated) P14; else leave as is
    occupation = if_else(
      !is.na(P15),
      paste(occupation, P15, sep = " / "),  # use whatever separator you like
      occupation
    )
  )
regressor$occupation <- str_remove_all(regressor$occupation, "(^NA\\s*/\\s*)|(\\s*/\\s*NA$)")

regressor<-regressor%>%
  mutate(occupation= as.numeric(occupation)) %>%
  select(-P13, -P15)

regressor<-regressor%>%
  mutate(occupation= case_when(
    occupation %in% c(1,2,3,4,5,22) ~ "student",
    occupation %in% c(11,12) ~ "employed",
    occupation %in% c(13,14,15,16) ~ "self-employed",
    occupation %in% c(6,7,8,9,17) ~ "informal",
    occupation == 97 ~ "NA",
    TRUE ~ "Other-unemployed"
  ))
regressor$occupation <- as.factor(regressor$occupation)
regressor$occupation <- relevel(regressor$occupation, ref = "Other-unemployed") # Relevel to set the reference category

regressor<-regressor%>%
  mutate(income= case_when(
    income %in% c(1,2,3) ~ "Low",
    income %in% c(4,5,6) ~ "lower-mid",
    income %in% c(7,8) ~ "Upper-mid",
    income %in% c(9,10,11) ~ "High",
    TRUE ~ "Other"
    ))%>%
  mutate(income = as.factor(income))
regressor$income <- relevel(regressor$income, ref = "Other") # Relevel to set the reference category

regressor<-regressor%>%
  mutate(live_time= case_when(
    live_time %in% c(1,2) ~ "short",
    live_time %in% c(3,4) ~ "medium",
    live_time %in% c(5,6) ~ "long",
    TRUE ~ "NA"
  )) %>%
  mutate(live_time = as.factor(live_time))

regressor$live_time <- relevel(regressor$live_time, ref = "medium") # Relevel to set the reference category

regressor <- regressor %>%
  mutate(
    age = if_else(
      age %in% c(1,2),
      "under_18",
      as.character(age)      # keeps the original age for everyone else
    )
  )%>%
  mutate(age = as.factor(age))



model_house<-multinom(P95~.,data=regressor)

z<-summary(model_house)$coefficients/summary(model_house)$standard.errors
p_values<- (1 - pnorm(abs(z), 0, 1)) * 2

# 1. grab raw summary
s       <- summary(model_house)
coef_mat<- s$coefficients
se_mat  <- s$standard.errors

# 2. compute z-scores & p-values
z_mat <- coef_mat / se_mat
p_mat <- 2 * pnorm(-abs(z_mat))

# 3. pivot to long form
df_coef <- as.data.frame(coef_mat) %>%
  rownames_to_column("Outcome") %>%
  pivot_longer(-Outcome, names_to="Predictor", values_to="Coef")
df_se   <- as.data.frame(se_mat) %>%
  rownames_to_column("Outcome") %>%
  pivot_longer(-Outcome, names_to="Predictor", values_to="SE")
df_z    <- as.data.frame(z_mat) %>%
  rownames_to_column("Outcome") %>%
  pivot_longer(-Outcome, names_to="Predictor", values_to="z")
df_p    <- as.data.frame(p_mat) %>%
  rownames_to_column("Outcome") %>%
  pivot_longer(-Outcome, names_to="Predictor", values_to="p.value")

# 4. join and format, adding stars
results <- df_coef %>%
  left_join(df_se, by=c("Outcome","Predictor")) %>%
  left_join(df_z,  by=c("Outcome","Predictor")) %>%
  left_join(df_p,  by=c("Outcome","Predictor")) %>%
  mutate(
    OR      = exp(Coef),
    across(c(Coef, SE, z, OR, p.value), ~ round(., 3)),
    stars   = case_when(
      p.value < 0.001 ~ "***",
      p.value < 0.01  ~ "**",
      p.value < 0.05  ~ "*",
      TRUE            ~ ""
    ),
    OR       = paste0(OR, stars)
  ) %>%
  select(Outcome, Predictor, OR, Coef, SE, z, p.value)

# 5. render as styled HTML
kable(
  results,
  format     = "html",
  table.attr = 'class="table table-striped"',
  col.names  = c("Outcome", "Predictor", "OR", "Coef", "SE", "z-score", "p-value"),
  caption    = "Multinomial logit: Odds Ratios (with significance), Coefs, SEs, z-scores & p-values"
) %>%
  kable_styling(
    bootstrap_options = c("striped", "hover", "condensed", "responsive"),
    full_width        = FALSE
  )
```

## P96: Travel time

### Question:

**Statement: Travel time/commute to your most frequent travel destination.**

### Potential Answers:
- 1: It will increase
- 2: Will be maintained
- 3: It will decrease


```{r}
trips <- readRDS("data/008-24 BBDD Procesamiento Etapas.rds")
hog <- readRDS("data/008-24 BBDD Procesamiento Hogares.rds")
per <- readRDS("data/008-24 BBDD Procesamiento Personas.rds")

per_complt <- per %>%
  left_join(hog,by="ID_Hogar")

dependent_variable<- "P96"
independent_variables <- c("P3", "P42",
                           "P50", "P12", "P14",
                           "Edad", "P10", "P12","P13","P15", "P14", "P82", "P83")

regressor<- per_complt %>%
  select(all_of(dependent_variable), all_of(independent_variables))


regressor <- regressor %>%
  mutate(
    across(
      where(is.labelled),    # pick all haven_labelled columns
      ~ zap_labels(.)        # strip off the labels, leaving the underlying numeric
    )
  )
regressor$P96 <- as.factor(regressor$P96)
regressor$P96 <- relevel(regressor$P96, ref = "2") # Relevel to set the reference category

regressor<-regressor%>%
  rename(pop_num=P3,
         major_trans_2020=P42,
         income= P50,
         rent_own= P82,
         live_time= P83
         )

regressor<-regressor%>%
  rename(edu_att= P12,
         occupation= P14,
         gender= P10,
         age= Edad
         )


regressor$rent_own<- as.factor(regressor$rent_own) # own =1, rent =2
regressor$rent_own <- relevel(regressor$rent_own, ref = "1") # Relevel to set the reference category
regressor$gender <- as.factor(regressor$gender) #female =1, male=2
regressor$gender <- relevel(regressor$gender, ref = "2") # Relevel to set the reference category


regressor$edu_att <- dplyr::case_when(
  regressor$edu_att %in% c(1, 2, 3) ~ "Primary",
  regressor$edu_att %in% c(4, 5) ~ "LowerSecondary",
  regressor$edu_att %in% c(6, 7) ~ "UpperSecondary",
  regressor$edu_att %in% c(8, 9) ~ "Technological",
  regressor$edu_att %in% c(10, 11, 12, 13) ~ "University",
  regressor$edu_att == 97 ~ "NA",
)
regressor$edu_att <- as.factor(regressor$edu_att)
regressor$edu_att <- relevel(regressor$edu_att, ref = "UpperSecondary") # Relevel to set the reference category

regressor<-regressor %>%
  mutate(major_trans_2020= case_when(
    major_trans_2020 %in% c(1,2,3,4,5,6,10,16) ~ "public_tansit",
    major_trans_2020 %in% c(7,8,9) ~ "informal",
    major_trans_2020 %in% c(11,12) ~ "taxi",
    major_trans_2020 %in% c(22,23) ~ "personal_veh",
    major_trans_2020 %in% c(24,25) ~"motorcyle",
    major_trans_2020 %in% c(25,27,28,17) ~ "bicycle",
    major_trans_2020==34 ~ "walking",
    TRUE ~ "other"
))
regressor$major_trans_2020<-as.factor(regressor$major_trans_2020)
regressor$major_trans_2020<-relevel(regressor$major_trans_2020,ref = "other")

regressor <- regressor %>%
  mutate(
    # 1) if P13 not NA, take P13, otherwise keep original P14
    occupation = if_else(!is.na(P13), as.character(P13), as.character(occupation)),
    # 2) if P15 not NA, paste it to the (possibly updated) P14; else leave as is
    occupation = if_else(
      !is.na(P15),
      paste(occupation, P15, sep = " / "),  # use whatever separator you like
      occupation
    )
  )
regressor$occupation <- str_remove_all(regressor$occupation, "(^NA\\s*/\\s*)|(\\s*/\\s*NA$)")

regressor<-regressor%>%
  mutate(occupation= as.numeric(occupation)) %>%
  select(-P13, -P15)

regressor<-regressor%>%
  mutate(occupation= case_when(
    occupation %in% c(1,2,3,4,5,22) ~ "student",
    occupation %in% c(11,12) ~ "employed",
    occupation %in% c(13,14,15,16) ~ "self-employed",
    occupation %in% c(6,7,8,9,17) ~ "informal",
    occupation == 97 ~ "NA",
    TRUE ~ "Other-unemployed"
  ))
regressor$occupation <- as.factor(regressor$occupation)
regressor$occupation <- relevel(regressor$occupation, ref = "Other-unemployed") # Relevel to set the reference category

regressor<-regressor%>%
  mutate(income= case_when(
    income %in% c(1,2,3) ~ "Low",
    income %in% c(4,5,6) ~ "lower-mid",
    income %in% c(7,8) ~ "Upper-mid",
    income %in% c(9,10,11) ~ "High",
    TRUE ~ "Other"
    ))%>%
  mutate(income = as.factor(income))
regressor$income <- relevel(regressor$income, ref = "Other") # Relevel to set the reference category

regressor<-regressor%>%
  mutate(live_time= case_when(
    live_time %in% c(1,2) ~ "short",
    live_time %in% c(3,4) ~ "medium",
    live_time %in% c(5,6) ~ "long",
    TRUE ~ "NA"
  )) %>%
  mutate(live_time = as.factor(live_time))

regressor$live_time <- relevel(regressor$live_time, ref = "medium") # Relevel to set the reference category

regressor <- regressor %>%
  mutate(
    age = if_else(
      age %in% c(1,2),
      "under_18",
      as.character(age)      # keeps the original age for everyone else
    )
  )%>%
  mutate(age = as.factor(age))



model_house<-multinom(P96~.,data=regressor)

z<-summary(model_house)$coefficients/summary(model_house)$standard.errors
p_values<- (1 - pnorm(abs(z), 0, 1)) * 2

# 1. grab raw summary
s       <- summary(model_house)
coef_mat<- s$coefficients
se_mat  <- s$standard.errors

# 2. compute z-scores & p-values
z_mat <- coef_mat / se_mat
p_mat <- 2 * pnorm(-abs(z_mat))

# 3. pivot to long form
df_coef <- as.data.frame(coef_mat) %>%
  rownames_to_column("Outcome") %>%
  pivot_longer(-Outcome, names_to="Predictor", values_to="Coef")
df_se   <- as.data.frame(se_mat) %>%
  rownames_to_column("Outcome") %>%
  pivot_longer(-Outcome, names_to="Predictor", values_to="SE")
df_z    <- as.data.frame(z_mat) %>%
  rownames_to_column("Outcome") %>%
  pivot_longer(-Outcome, names_to="Predictor", values_to="z")
df_p    <- as.data.frame(p_mat) %>%
  rownames_to_column("Outcome") %>%
  pivot_longer(-Outcome, names_to="Predictor", values_to="p.value")

# 4. join and format, adding stars
results <- df_coef %>%
  left_join(df_se, by=c("Outcome","Predictor")) %>%
  left_join(df_z,  by=c("Outcome","Predictor")) %>%
  left_join(df_p,  by=c("Outcome","Predictor")) %>%
  mutate(
    OR      = exp(Coef),
    across(c(Coef, SE, z, OR, p.value), ~ round(., 3)),
    stars   = case_when(
      p.value < 0.001 ~ "***",
      p.value < 0.01  ~ "**",
      p.value < 0.05  ~ "*",
      TRUE            ~ ""
    ),
    OR       = paste0(OR, stars)
  ) %>%
  select(Outcome, Predictor, OR, Coef, SE, z, p.value)

# 5. render as styled HTML
kable(
  results,
  format     = "html",
  table.attr = 'class="table table-striped"',
  col.names  = c("Outcome", "Predictor", "OR", "Coef", "SE", "z-score", "p-value"),
  caption    = "Multinomial logit: Odds Ratios (with significance), Coefs, SEs, z-scores & p-values"
) %>%
  kable_styling(
    bootstrap_options = c("striped", "hover", "condensed", "responsive"),
    full_width        = FALSE
  )
```

## P98: Hearing pollution

### Question:

**Statement: Hearing pollution**

### Potential Answers:
- 1: It will increase
- 2: Will be maintained
- 3: It will decrease


```{r}
trips <- readRDS("data/008-24 BBDD Procesamiento Etapas.rds")
hog <- readRDS("data/008-24 BBDD Procesamiento Hogares.rds")
per <- readRDS("data/008-24 BBDD Procesamiento Personas.rds")

per_complt <- per %>%
  left_join(hog,by="ID_Hogar")

dependent_variable<- "P98"
independent_variables <- c("P3", "P42",
                           "P50", "P12", "P14",
                           "Edad", "P10", "P12","P13","P15", "P14", "P82", "P83")

regressor<- per_complt %>%
  select(all_of(dependent_variable), all_of(independent_variables))


regressor <- regressor %>%
  mutate(
    across(
      where(is.labelled),    # pick all haven_labelled columns
      ~ zap_labels(.)        # strip off the labels, leaving the underlying numeric
    )
  )
regressor$P98 <- as.factor(regressor$P98)
regressor$P98 <- relevel(regressor$P98, ref = "2") # Relevel to set the reference category

regressor<-regressor%>%
  rename(pop_num=P3,
         major_trans_2020=P42,
         income= P50,
         rent_own= P82,
         live_time= P83
         )

regressor<-regressor%>%
  rename(edu_att= P12,
         occupation= P14,
         gender= P10,
         age= Edad
         )


regressor$rent_own<- as.factor(regressor$rent_own) # own =1, rent =2
regressor$rent_own <- relevel(regressor$rent_own, ref = "1") # Relevel to set the reference category
regressor$gender <- as.factor(regressor$gender) #female =1, male=2
regressor$gender <- relevel(regressor$gender, ref = "2") # Relevel to set the reference category


regressor$edu_att <- dplyr::case_when(
  regressor$edu_att %in% c(1, 2, 3) ~ "Primary",
  regressor$edu_att %in% c(4, 5) ~ "LowerSecondary",
  regressor$edu_att %in% c(6, 7) ~ "UpperSecondary",
  regressor$edu_att %in% c(8, 9) ~ "Technological",
  regressor$edu_att %in% c(10, 11, 12, 13) ~ "University",
  regressor$edu_att == 97 ~ "NA",
)
regressor$edu_att <- as.factor(regressor$edu_att)
regressor$edu_att <- relevel(regressor$edu_att, ref = "UpperSecondary") # Relevel to set the reference category

regressor<-regressor %>%
  mutate(major_trans_2020= case_when(
    major_trans_2020 %in% c(1,2,3,4,5,6,10,16) ~ "public_tansit",
    major_trans_2020 %in% c(7,8,9) ~ "informal",
    major_trans_2020 %in% c(11,12) ~ "taxi",
    major_trans_2020 %in% c(22,23) ~ "personal_veh",
    major_trans_2020 %in% c(24,25) ~"motorcyle",
    major_trans_2020 %in% c(25,27,28,17) ~ "bicycle",
    major_trans_2020==34 ~ "walking",
    TRUE ~ "other"
))
regressor$major_trans_2020<-as.factor(regressor$major_trans_2020)
regressor$major_trans_2020<-relevel(regressor$major_trans_2020,ref = "other")

regressor <- regressor %>%
  mutate(
    # 1) if P13 not NA, take P13, otherwise keep original P14
    occupation = if_else(!is.na(P13), as.character(P13), as.character(occupation)),
    # 2) if P15 not NA, paste it to the (possibly updated) P14; else leave as is
    occupation = if_else(
      !is.na(P15),
      paste(occupation, P15, sep = " / "),  # use whatever separator you like
      occupation
    )
  )
regressor$occupation <- str_remove_all(regressor$occupation, "(^NA\\s*/\\s*)|(\\s*/\\s*NA$)")

regressor<-regressor%>%
  mutate(occupation= as.numeric(occupation)) %>%
  select(-P13, -P15)

regressor<-regressor%>%
  mutate(occupation= case_when(
    occupation %in% c(1,2,3,4,5,22) ~ "student",
    occupation %in% c(11,12) ~ "employed",
    occupation %in% c(13,14,15,16) ~ "self-employed",
    occupation %in% c(6,7,8,9,17) ~ "informal",
    occupation == 97 ~ "NA",
    TRUE ~ "Other-unemployed"
  ))
regressor$occupation <- as.factor(regressor$occupation)
regressor$occupation <- relevel(regressor$occupation, ref = "Other-unemployed") # Relevel to set the reference category

regressor<-regressor%>%
  mutate(income= case_when(
    income %in% c(1,2,3) ~ "Low",
    income %in% c(4,5,6) ~ "lower-mid",
    income %in% c(7,8) ~ "Upper-mid",
    income %in% c(9,10,11) ~ "High",
    TRUE ~ "Other"
    ))%>%
  mutate(income = as.factor(income))
regressor$income <- relevel(regressor$income, ref = "Other") # Relevel to set the reference category

regressor<-regressor%>%
  mutate(live_time= case_when(
    live_time %in% c(1,2) ~ "short",
    live_time %in% c(3,4) ~ "medium",
    live_time %in% c(5,6) ~ "long",
    TRUE ~ "NA"
  )) %>%
  mutate(live_time = as.factor(live_time))

regressor$live_time <- relevel(regressor$live_time, ref = "medium") # Relevel to set the reference category

regressor <- regressor %>%
  mutate(
    age = if_else(
      age %in% c(1,2),
      "under_18",
      as.character(age)      # keeps the original age for everyone else
    )
  )%>%
  mutate(age = as.factor(age))



model_house<-multinom(P98~.,data=regressor)

z<-summary(model_house)$coefficients/summary(model_house)$standard.errors
p_values<- (1 - pnorm(abs(z), 0, 1)) * 2

# 1. grab raw summary
s       <- summary(model_house)
coef_mat<- s$coefficients
se_mat  <- s$standard.errors

# 2. compute z-scores & p-values
z_mat <- coef_mat / se_mat
p_mat <- 2 * pnorm(-abs(z_mat))

# 3. pivot to long form
df_coef <- as.data.frame(coef_mat) %>%
  rownames_to_column("Outcome") %>%
  pivot_longer(-Outcome, names_to="Predictor", values_to="Coef")
df_se   <- as.data.frame(se_mat) %>%
  rownames_to_column("Outcome") %>%
  pivot_longer(-Outcome, names_to="Predictor", values_to="SE")
df_z    <- as.data.frame(z_mat) %>%
  rownames_to_column("Outcome") %>%
  pivot_longer(-Outcome, names_to="Predictor", values_to="z")
df_p    <- as.data.frame(p_mat) %>%
  rownames_to_column("Outcome") %>%
  pivot_longer(-Outcome, names_to="Predictor", values_to="p.value")

# 4. join and format, adding stars
results <- df_coef %>%
  left_join(df_se, by=c("Outcome","Predictor")) %>%
  left_join(df_z,  by=c("Outcome","Predictor")) %>%
  left_join(df_p,  by=c("Outcome","Predictor")) %>%
  mutate(
    OR      = exp(Coef),
    across(c(Coef, SE, z, OR, p.value), ~ round(., 3)),
    stars   = case_when(
      p.value < 0.001 ~ "***",
      p.value < 0.01  ~ "**",
      p.value < 0.05  ~ "*",
      TRUE            ~ ""
    ),
    OR       = paste0(OR, stars)
  ) %>%
  select(Outcome, Predictor, OR, Coef, SE, z, p.value)

# 5. render as styled HTML
kable(
  results,
  format     = "html",
  table.attr = 'class="table table-striped"',
  col.names  = c("Outcome", "Predictor", "OR", "Coef", "SE", "z-score", "p-value"),
  caption    = "Multinomial logit: Odds Ratios (with significance), Coefs, SEs, z-scores & p-values"
) %>%
  kable_styling(
    bootstrap_options = c("striped", "hover", "condensed", "responsive"),
    full_width        = FALSE
  )
```

## P100: Public spaces

### Question:

**Statement: Public spaces (sidewalks, green areas, parks)**

### Potential Answers:
- 1: It will increase
- 2: Will be maintained
- 3: It will decrease

```{r}
trips <- readRDS("data/008-24 BBDD Procesamiento Etapas.rds")
hog <- readRDS("data/008-24 BBDD Procesamiento Hogares.rds")
per <- readRDS("data/008-24 BBDD Procesamiento Personas.rds")

per_complt <- per %>%
  left_join(hog,by="ID_Hogar")

dependent_variable<- "P100"
independent_variables <- c("P3", "P42",
                           "P50", "P12", "P14",
                           "Edad", "P10", "P12","P13","P15", "P14", "P82", "P83")

regressor<- per_complt %>%
  select(all_of(dependent_variable), all_of(independent_variables))


regressor <- regressor %>%
  mutate(
    across(
      where(is.labelled),    # pick all haven_labelled columns
      ~ zap_labels(.)        # strip off the labels, leaving the underlying numeric
    )
  )
regressor$P100 <- as.factor(regressor$P100)
regressor$P100 <- relevel(regressor$P100, ref = "2") # Relevel to set the reference category

regressor<-regressor%>%
  rename(
         pop_num=P3,
         major_trans_2020=P42,
         income= P50,
         rent_own= P82,
         live_time= P83
         )

regressor<-regressor%>%
  rename(edu_att= P12,
         occupation= P14,
         gender= P10,
         age= Edad
         )


regressor$rent_own<- as.factor(regressor$rent_own) # own =1, rent =2
regressor$rent_own <- relevel(regressor$rent_own, ref = "1") # Relevel to set the reference category
regressor$gender <- as.factor(regressor$gender) #female =1, male=2
regressor$gender <- relevel(regressor$gender, ref = "2") # Relevel to set the reference category


regressor$edu_att <- dplyr::case_when(
  regressor$edu_att %in% c(1, 2, 3) ~ "Primary",
  regressor$edu_att %in% c(4, 5) ~ "LowerSecondary",
  regressor$edu_att %in% c(6, 7) ~ "UpperSecondary",
  regressor$edu_att %in% c(8, 9) ~ "Technological",
  regressor$edu_att %in% c(10, 11, 12, 13) ~ "University",
  regressor$edu_att == 97 ~ "NA",
)
regressor$edu_att <- as.factor(regressor$edu_att)
regressor$edu_att <- relevel(regressor$edu_att, ref = "UpperSecondary") # Relevel to set the reference category

regressor<-regressor %>%
  mutate(major_trans_2020= case_when(
    major_trans_2020 %in% c(1,2,3,4,5,6,10,16) ~ "public_tansit",
    major_trans_2020 %in% c(7,8,9) ~ "informal",
    major_trans_2020 %in% c(11,12) ~ "taxi",
    major_trans_2020 %in% c(22,23) ~ "personal_veh",
    major_trans_2020 %in% c(24,25) ~"motorcyle",
    major_trans_2020 %in% c(25,27,28,17) ~ "bicycle",
    major_trans_2020==34 ~ "walking",
    TRUE ~ "other"
))
regressor$major_trans_2020<-as.factor(regressor$major_trans_2020)
regressor$major_trans_2020<-relevel(regressor$major_trans_2020,ref = "other")

regressor <- regressor %>%
  mutate(
    # 1) if P13 not NA, take P13, otherwise keep original P14
    occupation = if_else(!is.na(P13), as.character(P13), as.character(occupation)),
    # 2) if P15 not NA, paste it to the (possibly updated) P14; else leave as is
    occupation = if_else(
      !is.na(P15),
      paste(occupation, P15, sep = " / "),  # use whatever separator you like
      occupation
    )
  )
regressor$occupation <- str_remove_all(regressor$occupation, "(^NA\\s*/\\s*)|(\\s*/\\s*NA$)")

regressor<-regressor%>%
  mutate(occupation= as.numeric(occupation)) %>%
  select(-P13, -P15)

regressor<-regressor%>%
  mutate(occupation= case_when(
    occupation %in% c(1,2,3,4,5,22) ~ "student",
    occupation %in% c(11,12) ~ "employed",
    occupation %in% c(13,14,15,16) ~ "self-employed",
    occupation %in% c(6,7,8,9,17) ~ "informal",
    occupation == 97 ~ "NA",
    TRUE ~ "Other-unemployed"
  ))
regressor$occupation <- as.factor(regressor$occupation)
regressor$occupation <- relevel(regressor$occupation, ref = "Other-unemployed") # Relevel to set the reference category

regressor<-regressor%>%
  mutate(income= case_when(
    income %in% c(1,2,3) ~ "Low",
    income %in% c(4,5,6) ~ "lower-mid",
    income %in% c(7,8) ~ "Upper-mid",
    income %in% c(9,10,11) ~ "High",
    TRUE ~ "Other"
    ))%>%
  mutate(income = as.factor(income))
regressor$income <- relevel(regressor$income, ref = "Other") # Relevel to set the reference category

regressor<-regressor%>%
  mutate(live_time= case_when(
    live_time %in% c(1,2) ~ "short",
    live_time %in% c(3,4) ~ "medium",
    live_time %in% c(5,6) ~ "long",
    TRUE ~ "NA"
  )) %>%
  mutate(live_time = as.factor(live_time))

regressor$live_time <- relevel(regressor$live_time, ref = "medium") # Relevel to set the reference category

regressor <- regressor %>%
  mutate(
    age = if_else(
      age %in% c(1,2),
      "under_18",
      as.character(age)      # keeps the original age for everyone else
    )
  )%>%
  mutate(age = as.factor(age))



model_house<-multinom(P100~.,data=regressor)

z<-summary(model_house)$coefficients/summary(model_house)$standard.errors
p_values<- (1 - pnorm(abs(z), 0, 1)) * 2

# 1. grab raw summary
s       <- summary(model_house)
coef_mat<- s$coefficients
se_mat  <- s$standard.errors

# 2. compute z-scores & p-values
z_mat <- coef_mat / se_mat
p_mat <- 2 * pnorm(-abs(z_mat))

# 3. pivot to long form
df_coef <- as.data.frame(coef_mat) %>%
  rownames_to_column("Outcome") %>%
  pivot_longer(-Outcome, names_to="Predictor", values_to="Coef")
df_se   <- as.data.frame(se_mat) %>%
  rownames_to_column("Outcome") %>%
  pivot_longer(-Outcome, names_to="Predictor", values_to="SE")
df_z    <- as.data.frame(z_mat) %>%
  rownames_to_column("Outcome") %>%
  pivot_longer(-Outcome, names_to="Predictor", values_to="z")
df_p    <- as.data.frame(p_mat) %>%
  rownames_to_column("Outcome") %>%
  pivot_longer(-Outcome, names_to="Predictor", values_to="p.value")

# 4. join and format, adding stars
results <- df_coef %>%
  left_join(df_se, by=c("Outcome","Predictor")) %>%
  left_join(df_z,  by=c("Outcome","Predictor")) %>%
  left_join(df_p,  by=c("Outcome","Predictor")) %>%
  mutate(
    OR      = exp(Coef),
    across(c(Coef, SE, z, OR, p.value), ~ round(., 3)),
    stars   = case_when(
      p.value < 0.001 ~ "***",
      p.value < 0.01  ~ "**",
      p.value < 0.05  ~ "*",
      TRUE            ~ ""
    ),
    OR       = paste0(OR, stars)
  ) %>%
  select(Outcome, Predictor, OR, Coef, SE, z, p.value)

# 5. render as styled HTML
kable(
  results,
  format     = "html",
  table.attr = 'class="table table-striped"',
  col.names  = c("Outcome", "Predictor", "OR", "Coef", "SE", "z-score", "p-value"),
  caption    = "Multinomial logit: Odds Ratios (with significance), Coefs, SEs, z-scores & p-values"
) %>%
  kable_styling(
    bootstrap_options = c("striped", "hover", "condensed", "responsive"),
    full_width        = FALSE
  )
```

## P101: New housing projects

### Question:

**Statement: New housing projects**

### Potential Answers:
- 1: It will increase
- 2: Will be maintained
- 3: It will decrease

```{r}
trips <- readRDS("data/008-24 BBDD Procesamiento Etapas.rds")
hog <- readRDS("data/008-24 BBDD Procesamiento Hogares.rds")
per <- readRDS("data/008-24 BBDD Procesamiento Personas.rds")

per_complt <- per %>%
  left_join(hog,by="ID_Hogar")

dependent_variable<- "P101"
independent_variables <- c("P3", "P42",
                           "P50", "P12", "P14",
                           "Edad", "P10", "P12","P13","P15", "P14", "P82", "P83")

regressor<- per_complt %>%
  select(all_of(dependent_variable), all_of(independent_variables))


regressor <- regressor %>%
  mutate(
    across(
      where(is.labelled),    # pick all haven_labelled columns
      ~ zap_labels(.)        # strip off the labels, leaving the underlying numeric
    )
  )
regressor$P101 <- as.factor(regressor$P101)
regressor$P101 <- relevel(regressor$P101, ref = "2") # Relevel to set the reference category

regressor<-regressor%>%
  rename(pop_num=P3,
         major_trans_2020=P42,
         income= P50,
         rent_own= P82,
         live_time= P83
         )

regressor<-regressor%>%
  rename(edu_att= P12,
         occupation= P14,
         gender= P10,
         age= Edad
         )


regressor$rent_own<- as.factor(regressor$rent_own) # own =1, rent =2
regressor$rent_own <- relevel(regressor$rent_own, ref = "1") # Relevel to set the reference category
regressor$gender <- as.factor(regressor$gender) #female =1, male=2
regressor$gender <- relevel(regressor$gender, ref = "2") # Relevel to set the reference category


regressor$edu_att <- dplyr::case_when(
  regressor$edu_att %in% c(1, 2, 3) ~ "Primary",
  regressor$edu_att %in% c(4, 5) ~ "LowerSecondary",
  regressor$edu_att %in% c(6, 7) ~ "UpperSecondary",
  regressor$edu_att %in% c(8, 9) ~ "Technological",
  regressor$edu_att %in% c(10, 11, 12, 13) ~ "University",
  regressor$edu_att == 97 ~ "NA",
)
regressor$edu_att <- as.factor(regressor$edu_att)
regressor$edu_att <- relevel(regressor$edu_att, ref = "UpperSecondary") # Relevel to set the reference category

regressor<-regressor %>%
  mutate(major_trans_2020= case_when(
    major_trans_2020 %in% c(1,2,3,4,5,6,10,16) ~ "public_tansit",
    major_trans_2020 %in% c(7,8,9) ~ "informal",
    major_trans_2020 %in% c(11,12) ~ "taxi",
    major_trans_2020 %in% c(22,23) ~ "personal_veh",
    major_trans_2020 %in% c(24,25) ~"motorcyle",
    major_trans_2020 %in% c(25,27,28,17) ~ "bicycle",
    major_trans_2020==34 ~ "walking",
    TRUE ~ "other"
))
regressor$major_trans_2020<-as.factor(regressor$major_trans_2020)
regressor$major_trans_2020<-relevel(regressor$major_trans_2020,ref = "other")

regressor <- regressor %>%
  mutate(
    # 1) if P13 not NA, take P13, otherwise keep original P14
    occupation = if_else(!is.na(P13), as.character(P13), as.character(occupation)),
    # 2) if P15 not NA, paste it to the (possibly updated) P14; else leave as is
    occupation = if_else(
      !is.na(P15),
      paste(occupation, P15, sep = " / "),  # use whatever separator you like
      occupation
    )
  )
regressor$occupation <- str_remove_all(regressor$occupation, "(^NA\\s*/\\s*)|(\\s*/\\s*NA$)")

regressor<-regressor%>%
  mutate(occupation= as.numeric(occupation)) %>%
  select(-P13, -P15)

regressor<-regressor%>%
  mutate(occupation= case_when(
    occupation %in% c(1,2,3,4,5,22) ~ "student",
    occupation %in% c(11,12) ~ "employed",
    occupation %in% c(13,14,15,16) ~ "self-employed",
    occupation %in% c(6,7,8,9,17) ~ "informal",
    occupation == 97 ~ "NA",
    TRUE ~ "Other-unemployed"
  ))
regressor$occupation <- as.factor(regressor$occupation)
regressor$occupation <- relevel(regressor$occupation, ref = "Other-unemployed") # Relevel to set the reference category

regressor<-regressor%>%
  mutate(income= case_when(
    income %in% c(1,2,3) ~ "Low",
    income %in% c(4,5,6) ~ "lower-mid",
    income %in% c(7,8) ~ "Upper-mid",
    income %in% c(9,10,11) ~ "High",
    TRUE ~ "Other"
    ))%>%
  mutate(income = as.factor(income))
regressor$income <- relevel(regressor$income, ref = "Other") # Relevel to set the reference category

regressor<-regressor%>%
  mutate(live_time= case_when(
    live_time %in% c(1,2) ~ "short",
    live_time %in% c(3,4) ~ "medium",
    live_time %in% c(5,6) ~ "long",
    TRUE ~ "NA"
  )) %>%
  mutate(live_time = as.factor(live_time))

regressor$live_time <- relevel(regressor$live_time, ref = "medium") # Relevel to set the reference category

regressor <- regressor %>%
  mutate(
    age = if_else(
      age %in% c(1,2),
      "under_18",
      as.character(age)      # keeps the original age for everyone else
    )
  )%>%
  mutate(age = as.factor(age))



model_house<-multinom(P101~.,data=regressor)

z<-summary(model_house)$coefficients/summary(model_house)$standard.errors
p_values<- (1 - pnorm(abs(z), 0, 1)) * 2

# 1. grab raw summary
s       <- summary(model_house)
coef_mat<- s$coefficients
se_mat  <- s$standard.errors

# 2. compute z-scores & p-values
z_mat <- coef_mat / se_mat
p_mat <- 2 * pnorm(-abs(z_mat))

# 3. pivot to long form
df_coef <- as.data.frame(coef_mat) %>%
  rownames_to_column("Outcome") %>%
  pivot_longer(-Outcome, names_to="Predictor", values_to="Coef")
df_se   <- as.data.frame(se_mat) %>%
  rownames_to_column("Outcome") %>%
  pivot_longer(-Outcome, names_to="Predictor", values_to="SE")
df_z    <- as.data.frame(z_mat) %>%
  rownames_to_column("Outcome") %>%
  pivot_longer(-Outcome, names_to="Predictor", values_to="z")
df_p    <- as.data.frame(p_mat) %>%
  rownames_to_column("Outcome") %>%
  pivot_longer(-Outcome, names_to="Predictor", values_to="p.value")

# 4. join and format, adding stars
results <- df_coef %>%
  left_join(df_se, by=c("Outcome","Predictor")) %>%
  left_join(df_z,  by=c("Outcome","Predictor")) %>%
  left_join(df_p,  by=c("Outcome","Predictor")) %>%
  mutate(
    OR      = exp(Coef),
    across(c(Coef, SE, z, OR, p.value), ~ round(., 3)),
    stars   = case_when(
      p.value < 0.001 ~ "***",
      p.value < 0.01  ~ "**",
      p.value < 0.05  ~ "*",
      TRUE            ~ ""
    ),
    OR       = paste0(OR, stars)
  ) %>%
  select(Outcome, Predictor, OR, Coef, SE, z, p.value)

# 5. render as styled HTML
kable(
  results,
  format     = "html",
  table.attr = 'class="table table-striped"',
  col.names  = c("Outcome", "Predictor", "OR", "Coef", "SE", "z-score", "p-value"),
  caption    = "Multinomial logit: Odds Ratios (with significance), Coefs, SEs, z-scores & p-values"
) %>%
  kable_styling(
    bootstrap_options = c("striped", "hover", "condensed", "responsive"),
    full_width        = FALSE
  )
```


# Limitation and Questions

## The first question:

If the majority of the people prefer one answer to the question, specifically, then this predictor is not statistically significant. (For P87, whether people think the housing values or rent would increase, if the majority of people, regardless of the type of house they live in, all think the housing price would rise, then the housing type predictor is not a great predictor.) Here, I want to get a sense of whether this question is more subjective or objective. However, I did identify some key factors that affect people’s responses. Understanding the nature of the question would help determine whether I should further explore the unreliable predictors or leave them as they are.


## The second question:
The second problem arises because I treated all predictor categories as unordered factors. From a statistical perspective, it can only interpret the results as indicating that one specific group of the answers (e.g., people with a university degree or higher) tends to be more optimistic than the reference group (e.g., people with primary school degrees). Still, it does not necessarily prove that people with higher degrees are more likely to be optimistic as well, because the statistics may show that those with secondary degrees may be less confident than those with higher degrees. To identify a trend, we may want to try a different approach to handle the predictors. Please let me know what you think. Thanks.


## Last question:
The last question is about whether multinomial regression is the greatest approach. The multinomial regression is ideal to predict an unordered categorical variable, but not an ordered categorical variable, because it uses one category (in this case, “unchanged” as baseline). The interpretation for the coefficient would be “The log-odds of responding 'increase' (or 'decrease') vs 'not change' are the beta coefficient higher for categories one compared to the reference categories.” Initially, I thought “Increase”, “unchanged”, and “decrease” as unordered categorical variables, simply meaning they are viewed as separate categories, disregarding the sequence here.

The ordered categorical variable is similar to students’ grades, where A (90-100) is the highest, followed by B (80-90), C (70-80), and D (60-70). They are ordered categorical variables, but not numeric. Eugene doubted my approach to treating increases, unchanged, and decreases as unrelated. If we want to recover a trend rather than log likelihood, we will need to use a different regression model – the ordinal regression model. However, the multinomial regression results remain valid and may be helpful in the future.
