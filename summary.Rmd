---
title: "Multinomial regression for Bogota Travel Survey"
author: "Zhanchao Yang"
date: "`r Sys.Date()`"
output:
  html_document:
    theme: flatly
    highlight: tango
    toc: true
    toc_float: true
    code_folding: hide
    code_download: yes
    mathjax: default
---
```{r, include = FALSE}
options(scipen=999)
library(tidyverse)
library(nnet)
library(haven)
library(dplyr)
library(tidyr)
library(tibble)
library(knitr)
library(kableExtra)
```


# P87: Multinomial Regression

### Question:
**"How do you think the value of the housing or rent in which you live will change after the inauguration of the First and Second Line of the Bogotá Metro?"**

### Potential Answer:
- 1: Will increase
- 2: Will not change
- 3: Will decrease

```{r}

trips <- readRDS("data/008-24 BBDD Procesamiento Etapas.rds")
hog <- readRDS("data/008-24 BBDD Procesamiento Hogares.rds")
per <- readRDS("data/008-24 BBDD Procesamiento Personas.rds")

per_complt <- per %>%
  left_join(hog,by="ID_Hogar")

dependent_variable<- "P87"
independent_variables <- c("P1", "P3", "P42",
                           "P50", "P12", "P14",
                           "Edad", "P10", "P12","P13","P15", "P14", "P82", "P83")

regressor<- per_complt %>%
  select(all_of(dependent_variable), all_of(independent_variables))


regressor <- regressor %>%
  mutate(
    across(
      where(is.labelled),    # pick all haven_labelled columns
      ~ zap_labels(.)        # strip off the labels, leaving the underlying numeric
    )
  )
regressor$P87 <- as.factor(regressor$P87)
regressor$P87<-relevel(regressor$P87, ref = "2") # Relevel to set the reference category

regressor<-regressor%>%
  rename(house=P1,
         pop_num=P3,
         major_trans_2020=P42,
         income= P50,
         rent_own= P82,
         live_time= P83
         )

regressor<-regressor%>%
  rename(edu_att= P12,
         occupation= P14,
         gender= P10,
         age= Edad
         )

regressor$house <- as.factor(regressor$house)
regressor$house<- relevel(regressor$house, ref = "4") # Relevel to set the reference category
regressor$rent_own<- as.factor(regressor$rent_own) # own =1, rent =2
regressor$rent_own <- relevel(regressor$rent_own, ref = "1") # Relevel to set the reference category
regressor$gender <- as.factor(regressor$gender) #female =1, male=2
regressor$gender <- relevel(regressor$gender, ref = "2") # Relevel to set the reference category


regressor$edu_att <- dplyr::case_when(
  regressor$edu_att %in% c(1, 2, 3) ~ "Primary",
  regressor$edu_att %in% c(4, 5) ~ "LowerSecondary",
  regressor$edu_att %in% c(6, 7) ~ "UpperSecondary",
  regressor$edu_att %in% c(8, 9) ~ "Technological",
  regressor$edu_att %in% c(10, 11, 12, 13) ~ "University",
  regressor$edu_att == 97 ~ "NA",
)
regressor$edu_att <- as.factor(regressor$edu_att)
regressor$edu_att <- relevel(regressor$edu_att, ref = "UpperSecondary") # Relevel to set the reference category

regressor<-regressor %>%
  mutate(major_trans_2020= case_when(
    major_trans_2020 %in% c(1,2,3,4,5,6,10,16) ~ "public_tansit",
    major_trans_2020 %in% c(7,8,9) ~ "informal",
    major_trans_2020 %in% c(11,12) ~ "taxi",
    major_trans_2020 %in% c(22,23) ~ "personal_veh",
    major_trans_2020 %in% c(24,25) ~"motorcyle",
    major_trans_2020 %in% c(25,27,28,17) ~ "bicycle",
    major_trans_2020==34 ~ "walking",
    TRUE ~ "other"
))
regressor$major_trans_2020<-as.factor(regressor$major_trans_2020)
regressor$major_trans_2020<-relevel(regressor$major_trans_2020,ref = "other")

regressor <- regressor %>%
  mutate(
    # 1) if P13 not NA, take P13, otherwise keep original P14
    occupation = if_else(!is.na(P13), as.character(P13), as.character(occupation)),
    # 2) if P15 not NA, paste it to the (possibly updated) P14; else leave as is
    occupation = if_else(
      !is.na(P15),
      paste(occupation, P15, sep = " / "),  # use whatever separator you like
      occupation
    )
  )
regressor$occupation <- str_remove_all(regressor$occupation, "(^NA\\s*/\\s*)|(\\s*/\\s*NA$)")

regressor<-regressor%>%
  mutate(occupation= as.numeric(occupation)) %>%
  select(-P13, -P15)

regressor<-regressor%>%
  mutate(occupation= case_when(
    occupation %in% c(1,2,3,4,5,22) ~ "student",
    occupation %in% c(11,12) ~ "employed",
    occupation %in% c(13,14,15,16) ~ "self-employed",
    occupation %in% c(6,7,8,9,17) ~ "informal",
    occupation == 97 ~ "NA",
    TRUE ~ "Other-unemployed"
  ))
regressor$occupation <- as.factor(regressor$occupation)
regressor$occupation <- relevel(regressor$occupation, ref = "Other-unemployed") # Relevel to set the reference category

regressor<-regressor%>%
  mutate(income= case_when(
    income %in% c(1,2,3) ~ "Low",
    income %in% c(4,5,6) ~ "lower-mid",
    income %in% c(7,8) ~ "Upper-mid",
    income %in% c(9,10,11) ~ "High",
    TRUE ~ "Other"
    ))%>%
  mutate(income = as.factor(income))
regressor$income <- relevel(regressor$income, ref = "Other") # Relevel to set the reference category

regressor<-regressor%>%
  mutate(live_time= case_when(
    live_time %in% c(1,2) ~ "short",
    live_time %in% c(3,4) ~ "medium",
    live_time %in% c(5,6) ~ "long",
    TRUE ~ "NA"
  )) %>%
  mutate(live_time = as.factor(live_time))

regressor$live_time <- relevel(regressor$live_time, ref = "medium") # Relevel to set the reference category

regressor <- regressor %>%
  mutate(
    age = if_else(
      age %in% c(1,2),
      "under_18",
      as.character(age)      # keeps the original age for everyone else
    )
  )%>%
  mutate(age = as.factor(age))



model_house<-multinom(P87~.,data=regressor)

z<-summary(model_house)$coefficients/summary(model_house)$standard.errors
p_values<- (1 - pnorm(abs(z), 0, 1)) * 2

# 1. grab raw summary
s       <- summary(model_house)
coef_mat<- s$coefficients
se_mat  <- s$standard.errors

# 2. compute z-scores & p-values
z_mat <- coef_mat / se_mat
p_mat <- 2 * pnorm(-abs(z_mat))

# 3. pivot to long form
df_coef <- as.data.frame(coef_mat) %>%
  rownames_to_column("Outcome") %>%
  pivot_longer(-Outcome, names_to="Predictor", values_to="Coef")
df_se   <- as.data.frame(se_mat) %>%
  rownames_to_column("Outcome") %>%
  pivot_longer(-Outcome, names_to="Predictor", values_to="SE")
df_z    <- as.data.frame(z_mat) %>%
  rownames_to_column("Outcome") %>%
  pivot_longer(-Outcome, names_to="Predictor", values_to="z")
df_p    <- as.data.frame(p_mat) %>%
  rownames_to_column("Outcome") %>%
  pivot_longer(-Outcome, names_to="Predictor", values_to="p.value")

# 4. join and format, adding stars
results <- df_coef %>%
  left_join(df_se, by=c("Outcome","Predictor")) %>%
  left_join(df_z,  by=c("Outcome","Predictor")) %>%
  left_join(df_p,  by=c("Outcome","Predictor")) %>%
  mutate(
    OR      = exp(Coef),
    across(c(Coef, SE, z, OR, p.value), ~ round(., 3)),
    stars   = case_when(
      p.value < 0.001 ~ "***",
      p.value < 0.01  ~ "**",
      p.value < 0.05  ~ "*",
      TRUE            ~ ""
    ),
    OR       = paste0(OR, stars)
  ) %>%
  select(Outcome, Predictor, OR, Coef, SE, z, p.value)

# 5. render as styled HTML
kable(
  results,
  format     = "html",
  table.attr = 'class="table table-striped"',
  col.names  = c("Outcome", "Predictor", "OR", "Coef", "SE", "z-score", "p-value"),
  caption    = "Multinomial logit: Odds Ratios (with significance), Coefs, SEs, z-scores & p-values"
) %>%
  kable_styling(
    bootstrap_options = c("striped", "hover", "condensed", "responsive"),
    full_width        = FALSE
  )
```


# P90: Multinomial Regression

### Question:
We would like to know your perception of the possible impacts of the First and Second Line of the Bogotá Metro once it is inaugurated and in operation. Please indicate your perception of each of the following statements:

**Safety in the neighborhood.**

### Potential Answers:
- 1: It will increase
- 2: Will be maintained
- 3: It will decrease

```{r}
trips <- readRDS("data/008-24 BBDD Procesamiento Etapas.rds")
hog <- readRDS("data/008-24 BBDD Procesamiento Hogares.rds")
per <- readRDS("data/008-24 BBDD Procesamiento Personas.rds")

per_complt <- per %>%
  left_join(hog,by="ID_Hogar")

dependent_variable<- "P90"
independent_variables <- c("P1", "P3", "P42",
                           "P50", "P12", "P14",
                           "Edad", "P10", "P12","P13","P15", "P14", "P82", "P83")

regressor<- per_complt %>%
  select(all_of(dependent_variable), all_of(independent_variables))


regressor <- regressor %>%
  mutate(
    across(
      where(is.labelled),    # pick all haven_labelled columns
      ~ zap_labels(.)        # strip off the labels, leaving the underlying numeric
    )
  )
regressor$P90 <- as.factor(regressor$P90)
regressor$P90<-relevel(regressor$P90, ref = "2") # Relevel to set the reference category

regressor<-regressor%>%
  rename(house=P1,
         pop_num=P3,
         major_trans_2020=P42,
         income= P50,
         rent_own= P82,
         live_time= P83
         )

regressor<-regressor%>%
  rename(edu_att= P12,
         occupation= P14,
         gender= P10,
         age= Edad
         )

regressor$house <- as.factor(regressor$house)
regressor$house<- relevel(regressor$house, ref = "4") # Relevel to set the reference category
regressor$rent_own<- as.factor(regressor$rent_own) # own =1, rent =2
regressor$rent_own <- relevel(regressor$rent_own, ref = "1") # Relevel to set the reference category
regressor$gender <- as.factor(regressor$gender) #female =1, male=2
regressor$gender <- relevel(regressor$gender, ref = "2") # Relevel to set the reference category


regressor$edu_att <- dplyr::case_when(
  regressor$edu_att %in% c(1, 2, 3) ~ "Primary",
  regressor$edu_att %in% c(4, 5) ~ "LowerSecondary",
  regressor$edu_att %in% c(6, 7) ~ "UpperSecondary",
  regressor$edu_att %in% c(8, 9) ~ "Technological",
  regressor$edu_att %in% c(10, 11, 12, 13) ~ "University",
  regressor$edu_att == 97 ~ "NA",
)
regressor$edu_att <- as.factor(regressor$edu_att)
regressor$edu_att <- relevel(regressor$edu_att, ref = "UpperSecondary") # Relevel to set the reference category

regressor<-regressor %>%
  mutate(major_trans_2020= case_when(
    major_trans_2020 %in% c(1,2,3,4,5,6,10,16) ~ "public_tansit",
    major_trans_2020 %in% c(7,8,9) ~ "informal",
    major_trans_2020 %in% c(11,12) ~ "taxi",
    major_trans_2020 %in% c(22,23) ~ "personal_veh",
    major_trans_2020 %in% c(24,25) ~"motorcyle",
    major_trans_2020 %in% c(25,27,28,17) ~ "bicycle",
    major_trans_2020==34 ~ "walking",
    TRUE ~ "other"
))
regressor$major_trans_2020<-as.factor(regressor$major_trans_2020)
regressor$major_trans_2020<-relevel(regressor$major_trans_2020,ref = "other")

regressor <- regressor %>%
  mutate(
    # 1) if P13 not NA, take P13, otherwise keep original P14
    occupation = if_else(!is.na(P13), as.character(P13), as.character(occupation)),
    # 2) if P15 not NA, paste it to the (possibly updated) P14; else leave as is
    occupation = if_else(
      !is.na(P15),
      paste(occupation, P15, sep = " / "),  # use whatever separator you like
      occupation
    )
  )
regressor$occupation <- str_remove_all(regressor$occupation, "(^NA\\s*/\\s*)|(\\s*/\\s*NA$)")

regressor<-regressor%>%
  mutate(occupation= as.numeric(occupation)) %>%
  select(-P13, -P15)

regressor<-regressor%>%
  mutate(occupation= case_when(
    occupation %in% c(1,2,3,4,5,22) ~ "student",
    occupation %in% c(11,12) ~ "employed",
    occupation %in% c(13,14,15,16) ~ "self-employed",
    occupation %in% c(6,7,8,9,17) ~ "informal",
    occupation == 97 ~ "NA",
    TRUE ~ "Other-unemployed"
  ))
regressor$occupation <- as.factor(regressor$occupation)
regressor$occupation <- relevel(regressor$occupation, ref = "Other-unemployed") # Relevel to set the reference category

regressor<-regressor%>%
  mutate(income= case_when(
    income %in% c(1,2,3) ~ "Low",
    income %in% c(4,5,6) ~ "lower-mid",
    income %in% c(7,8) ~ "Upper-mid",
    income %in% c(9,10,11) ~ "High",
    TRUE ~ "Other"
    ))%>%
  mutate(income = as.factor(income))
regressor$income <- relevel(regressor$income, ref = "Other") # Relevel to set the reference category

regressor<-regressor%>%
  mutate(live_time= case_when(
    live_time %in% c(1,2) ~ "short",
    live_time %in% c(3,4) ~ "medium",
    live_time %in% c(5,6) ~ "long",
    TRUE ~ "NA"
  )) %>%
  mutate(live_time = as.factor(live_time))

regressor$live_time <- relevel(regressor$live_time, ref = "medium") # Relevel to set the reference category

regressor <- regressor %>%
  mutate(
    age = if_else(
      age %in% c(1,2),
      "under_18",
      as.character(age)      # keeps the original age for everyone else
    )
  )%>%
  mutate(age = as.factor(age))



model_house<-multinom(P90~.,data=regressor)

z<-summary(model_house)$coefficients/summary(model_house)$standard.errors
p_values<- (1 - pnorm(abs(z), 0, 1)) * 2

# 1. grab raw summary
s       <- summary(model_house)
coef_mat<- s$coefficients
se_mat  <- s$standard.errors

# 2. compute z-scores & p-values
z_mat <- coef_mat / se_mat
p_mat <- 2 * pnorm(-abs(z_mat))

# 3. pivot to long form
df_coef <- as.data.frame(coef_mat) %>%
  rownames_to_column("Outcome") %>%
  pivot_longer(-Outcome, names_to="Predictor", values_to="Coef")
df_se   <- as.data.frame(se_mat) %>%
  rownames_to_column("Outcome") %>%
  pivot_longer(-Outcome, names_to="Predictor", values_to="SE")
df_z    <- as.data.frame(z_mat) %>%
  rownames_to_column("Outcome") %>%
  pivot_longer(-Outcome, names_to="Predictor", values_to="z")
df_p    <- as.data.frame(p_mat) %>%
  rownames_to_column("Outcome") %>%
  pivot_longer(-Outcome, names_to="Predictor", values_to="p.value")

# 4. join and format, adding stars
results <- df_coef %>%
  left_join(df_se, by=c("Outcome","Predictor")) %>%
  left_join(df_z,  by=c("Outcome","Predictor")) %>%
  left_join(df_p,  by=c("Outcome","Predictor")) %>%
  mutate(
    OR      = exp(Coef),
    across(c(Coef, SE, z, OR, p.value), ~ round(., 3)),
    stars   = case_when(
      p.value < 0.001 ~ "***",
      p.value < 0.01  ~ "**",
      p.value < 0.05  ~ "*",
      TRUE            ~ ""
    ),
    OR       = paste0(OR, stars)
  ) %>%
  select(Outcome, Predictor, OR, Coef, SE, z, p.value)

# 5. render as styled HTML
kable(
  results,
  format     = "html",
  table.attr = 'class="table table-striped"',
  col.names  = c("Outcome", "Predictor", "OR", "Coef", "SE", "z-score", "p-value"),
  caption    = "Multinomial logit: Odds Ratios (with significance), Coefs, SEs, z-scores & p-values"
) %>%
  kable_styling(
    bootstrap_options = c("striped", "hover", "condensed", "responsive"),
    full_width        = FALSE
  )
```

# P91: multinomial regression

### Question:

**Statement : Cost of living in the neighborhood.**

### Potential Answers:
- 1: It will increase
- 2: Will be maintained
- 3: It will decrease

```{r, warning= FALSE}
trips <- readRDS("data/008-24 BBDD Procesamiento Etapas.rds")
hog <- readRDS("data/008-24 BBDD Procesamiento Hogares.rds")
per <- readRDS("data/008-24 BBDD Procesamiento Personas.rds")

per_complt <- per %>%
  left_join(hog,by="ID_Hogar")

dependent_variable<- "P91"
independent_variables <- c("P1", "P3", "P42",
                           "P50", "P12", "P14",
                           "Edad", "P10", "P12","P13","P15", "P14", "P82", "P83")

regressor<- per_complt %>%
  select(all_of(dependent_variable), all_of(independent_variables))


regressor <- regressor %>%
  mutate(
    across(
      where(is.labelled),    # pick all haven_labelled columns
      ~ zap_labels(.)        # strip off the labels, leaving the underlying numeric
    )
  )
regressor$P91 <- as.factor(regressor$P91)
regressor$P91<-relevel(regressor$P91, ref = "2") # Relevel to set the reference category

regressor<-regressor%>%
  rename(house=P1,
         pop_num=P3,
         major_trans_2020=P42,
         income= P50,
         rent_own= P82,
         live_time= P83
         )

regressor<-regressor%>%
  rename(edu_att= P12,
         occupation= P14,
         gender= P10,
         age= Edad
         )

regressor$house <- as.factor(regressor$house)
regressor$house<- relevel(regressor$house, ref = "4") # Relevel to set the reference category
regressor$rent_own<- as.factor(regressor$rent_own) # own =1, rent =2
regressor$rent_own <- relevel(regressor$rent_own, ref = "1") # Relevel to set the reference category
regressor$gender <- as.factor(regressor$gender) #female =1, male=2
regressor$gender <- relevel(regressor$gender, ref = "2") # Relevel to set the reference category


regressor$edu_att <- dplyr::case_when(
  regressor$edu_att %in% c(1, 2, 3) ~ "Primary",
  regressor$edu_att %in% c(4, 5) ~ "LowerSecondary",
  regressor$edu_att %in% c(6, 7) ~ "UpperSecondary",
  regressor$edu_att %in% c(8, 9) ~ "Technological",
  regressor$edu_att %in% c(10, 11, 12, 13) ~ "University",
  regressor$edu_att == 97 ~ "NA",
)
regressor$edu_att <- as.factor(regressor$edu_att)
regressor$edu_att <- relevel(regressor$edu_att, ref = "UpperSecondary") # Relevel to set the reference category

regressor<-regressor %>%
  mutate(major_trans_2020= case_when(
    major_trans_2020 %in% c(1,2,3,4,5,6,10,16) ~ "public_tansit",
    major_trans_2020 %in% c(7,8,9) ~ "informal",
    major_trans_2020 %in% c(11,12) ~ "taxi",
    major_trans_2020 %in% c(22,23) ~ "personal_veh",
    major_trans_2020 %in% c(24,25) ~"motorcyle",
    major_trans_2020 %in% c(25,27,28,17) ~ "bicycle",
    major_trans_2020==34 ~ "walking",
    TRUE ~ "other"
))
regressor$major_trans_2020<-as.factor(regressor$major_trans_2020)
regressor$major_trans_2020<-relevel(regressor$major_trans_2020,ref = "other")

regressor <- regressor %>%
  mutate(
    # 1) if P13 not NA, take P13, otherwise keep original P14
    occupation = if_else(!is.na(P13), as.character(P13), as.character(occupation)),
    # 2) if P15 not NA, paste it to the (possibly updated) P14; else leave as is
    occupation = if_else(
      !is.na(P15),
      paste(occupation, P15, sep = " / "),  # use whatever separator you like
      occupation
    )
  )
regressor$occupation <- str_remove_all(regressor$occupation, "(^NA\\s*/\\s*)|(\\s*/\\s*NA$)")

regressor<-regressor%>%
  mutate(occupation= as.numeric(occupation)) %>%
  select(-P13, -P15)

regressor<-regressor%>%
  mutate(occupation= case_when(
    occupation %in% c(1,2,3,4,5,22) ~ "student",
    occupation %in% c(11,12) ~ "employed",
    occupation %in% c(13,14,15,16) ~ "self-employed",
    occupation %in% c(6,7,8,9,17) ~ "informal",
    occupation == 97 ~ "NA",
    TRUE ~ "Other-unemployed"
  ))
regressor$occupation <- as.factor(regressor$occupation)
regressor$occupation <- relevel(regressor$occupation, ref = "Other-unemployed") # Relevel to set the reference category

regressor<-regressor%>%
  mutate(income= case_when(
    income %in% c(1,2,3) ~ "Low",
    income %in% c(4,5,6) ~ "lower-mid",
    income %in% c(7,8) ~ "Upper-mid",
    income %in% c(9,10,11) ~ "High",
    TRUE ~ "Other"
    ))%>%
  mutate(income = as.factor(income))
regressor$income <- relevel(regressor$income, ref = "Other") # Relevel to set the reference category

regressor<-regressor%>%
  mutate(live_time= case_when(
    live_time %in% c(1,2) ~ "short",
    live_time %in% c(3,4) ~ "medium",
    live_time %in% c(5,6) ~ "long",
    TRUE ~ "NA"
  )) %>%
  mutate(live_time = as.factor(live_time))

regressor$live_time <- relevel(regressor$live_time, ref = "medium") # Relevel to set the reference category

regressor <- regressor %>%
  mutate(
    age = if_else(
      age %in% c(1,2),
      "under_18",
      as.character(age)      # keeps the original age for everyone else
    )
  )%>%
  mutate(age = as.factor(age))



model_house<-multinom(P91~.,data=regressor)

z<-summary(model_house)$coefficients/summary(model_house)$standard.errors
p_values<- (1 - pnorm(abs(z), 0, 1)) * 2

# 1. grab raw summary
s       <- summary(model_house)
coef_mat<- s$coefficients
se_mat  <- s$standard.errors

# 2. compute z-scores & p-values
z_mat <- coef_mat / se_mat
p_mat <- 2 * pnorm(-abs(z_mat))

# 3. pivot to long form
df_coef <- as.data.frame(coef_mat) %>%
  rownames_to_column("Outcome") %>%
  pivot_longer(-Outcome, names_to="Predictor", values_to="Coef")
df_se   <- as.data.frame(se_mat) %>%
  rownames_to_column("Outcome") %>%
  pivot_longer(-Outcome, names_to="Predictor", values_to="SE")
df_z    <- as.data.frame(z_mat) %>%
  rownames_to_column("Outcome") %>%
  pivot_longer(-Outcome, names_to="Predictor", values_to="z")
df_p    <- as.data.frame(p_mat) %>%
  rownames_to_column("Outcome") %>%
  pivot_longer(-Outcome, names_to="Predictor", values_to="p.value")

# 4. join and format, adding stars
results <- df_coef %>%
  left_join(df_se, by=c("Outcome","Predictor")) %>%
  left_join(df_z,  by=c("Outcome","Predictor")) %>%
  left_join(df_p,  by=c("Outcome","Predictor")) %>%
  mutate(
    OR      = exp(Coef),
    across(c(Coef, SE, z, OR, p.value), ~ round(., 3)),
    stars   = case_when(
      p.value < 0.001 ~ "***",
      p.value < 0.01  ~ "**",
      p.value < 0.05  ~ "*",
      TRUE            ~ ""
    ),
    OR       = paste0(OR, stars)
  ) %>%
  select(Outcome, Predictor, OR, Coef, SE, z, p.value)

# 5. render as styled HTML
kable(
  results,
  format     = "html",
  table.attr = 'class="table table-striped"',
  col.names  = c("Outcome", "Predictor", "OR", "Coef", "SE", "z-score", "p-value"),
  caption    = "Multinomial logit: Odds Ratios (with significance), Coefs, SEs, z-scores & p-values"
) %>%
  kable_styling(
    bootstrap_options = c("striped", "hover", "condensed", "responsive"),
    full_width        = FALSE
  )
```

# P92: multinomial regression

### Question:

**Statement: Local commerce (formal and informal).**

### Potential Answers:
- 1: It will increase
- 2: Will be maintained
- 3: It will decrease


```{r}
trips <- readRDS("data/008-24 BBDD Procesamiento Etapas.rds")
hog <- readRDS("data/008-24 BBDD Procesamiento Hogares.rds")
per <- readRDS("data/008-24 BBDD Procesamiento Personas.rds")

per_complt <- per %>%
  left_join(hog,by="ID_Hogar")

dependent_variable<- "P92"
independent_variables <- c("P1", "P3", "P42",
                           "P50", "P12", "P14",
                           "Edad", "P10", "P12","P13","P15", "P14", "P82", "P83")

regressor<- per_complt %>%
  select(all_of(dependent_variable), all_of(independent_variables))


regressor <- regressor %>%
  mutate(
    across(
      where(is.labelled),    # pick all haven_labelled columns
      ~ zap_labels(.)        # strip off the labels, leaving the underlying numeric
    )
  )
regressor$P92 <- as.factor(regressor$P92)
regressor$P92<-relevel(regressor$P92, ref = "2") # Relevel to set the reference category

regressor<-regressor%>%
  rename(house=P1,
         pop_num=P3,
         major_trans_2020=P42,
         income= P50,
         rent_own= P82,
         live_time= P83
         )

regressor<-regressor%>%
  rename(edu_att= P12,
         occupation= P14,
         gender= P10,
         age= Edad
         )

regressor$house <- as.factor(regressor$house)
regressor$house<- relevel(regressor$house, ref = "4") # Relevel to set the reference category
regressor$rent_own<- as.factor(regressor$rent_own) # own =1, rent =2
regressor$rent_own <- relevel(regressor$rent_own, ref = "1") # Relevel to set the reference category
regressor$gender <- as.factor(regressor$gender) #female =1, male=2
regressor$gender <- relevel(regressor$gender, ref = "2") # Relevel to set the reference category


regressor$edu_att <- dplyr::case_when(
  regressor$edu_att %in% c(1, 2, 3) ~ "Primary",
  regressor$edu_att %in% c(4, 5) ~ "LowerSecondary",
  regressor$edu_att %in% c(6, 7) ~ "UpperSecondary",
  regressor$edu_att %in% c(8, 9) ~ "Technological",
  regressor$edu_att %in% c(10, 11, 12, 13) ~ "University",
  regressor$edu_att == 97 ~ "NA",
)
regressor$edu_att <- as.factor(regressor$edu_att)
regressor$edu_att <- relevel(regressor$edu_att, ref = "UpperSecondary") # Relevel to set the reference category

regressor<-regressor %>%
  mutate(major_trans_2020= case_when(
    major_trans_2020 %in% c(1,2,3,4,5,6,10,16) ~ "public_tansit",
    major_trans_2020 %in% c(7,8,9) ~ "informal",
    major_trans_2020 %in% c(11,12) ~ "taxi",
    major_trans_2020 %in% c(22,23) ~ "personal_veh",
    major_trans_2020 %in% c(24,25) ~"motorcyle",
    major_trans_2020 %in% c(25,27,28,17) ~ "bicycle",
    major_trans_2020==34 ~ "walking",
    TRUE ~ "other"
))
regressor$major_trans_2020<-as.factor(regressor$major_trans_2020)
regressor$major_trans_2020<-relevel(regressor$major_trans_2020,ref = "other")

regressor <- regressor %>%
  mutate(
    # 1) if P13 not NA, take P13, otherwise keep original P14
    occupation = if_else(!is.na(P13), as.character(P13), as.character(occupation)),
    # 2) if P15 not NA, paste it to the (possibly updated) P14; else leave as is
    occupation = if_else(
      !is.na(P15),
      paste(occupation, P15, sep = " / "),  # use whatever separator you like
      occupation
    )
  )
regressor$occupation <- str_remove_all(regressor$occupation, "(^NA\\s*/\\s*)|(\\s*/\\s*NA$)")

regressor<-regressor%>%
  mutate(occupation= as.numeric(occupation)) %>%
  select(-P13, -P15)

regressor<-regressor%>%
  mutate(occupation= case_when(
    occupation %in% c(1,2,3,4,5,22) ~ "student",
    occupation %in% c(11,12) ~ "employed",
    occupation %in% c(13,14,15,16) ~ "self-employed",
    occupation %in% c(6,7,8,9,17) ~ "informal",
    occupation == 97 ~ "NA",
    TRUE ~ "Other-unemployed"
  ))
regressor$occupation <- as.factor(regressor$occupation)
regressor$occupation <- relevel(regressor$occupation, ref = "Other-unemployed") # Relevel to set the reference category

regressor<-regressor%>%
  mutate(income= case_when(
    income %in% c(1,2,3) ~ "Low",
    income %in% c(4,5,6) ~ "lower-mid",
    income %in% c(7,8) ~ "Upper-mid",
    income %in% c(9,10,11) ~ "High",
    TRUE ~ "Other"
    ))%>%
  mutate(income = as.factor(income))
regressor$income <- relevel(regressor$income, ref = "Other") # Relevel to set the reference category

regressor<-regressor%>%
  mutate(live_time= case_when(
    live_time %in% c(1,2) ~ "short",
    live_time %in% c(3,4) ~ "medium",
    live_time %in% c(5,6) ~ "long",
    TRUE ~ "NA"
  )) %>%
  mutate(live_time = as.factor(live_time))

regressor$live_time <- relevel(regressor$live_time, ref = "medium") # Relevel to set the reference category

regressor <- regressor %>%
  mutate(
    age = if_else(
      age %in% c(1,2),
      "under_18",
      as.character(age)      # keeps the original age for everyone else
    )
  )%>%
  mutate(age = as.factor(age))



model_house<-multinom(P92~.,data=regressor)

z<-summary(model_house)$coefficients/summary(model_house)$standard.errors
p_values<- (1 - pnorm(abs(z), 0, 1)) * 2

# 1. grab raw summary
s       <- summary(model_house)
coef_mat<- s$coefficients
se_mat  <- s$standard.errors

# 2. compute z-scores & p-values
z_mat <- coef_mat / se_mat
p_mat <- 2 * pnorm(-abs(z_mat))

# 3. pivot to long form
df_coef <- as.data.frame(coef_mat) %>%
  rownames_to_column("Outcome") %>%
  pivot_longer(-Outcome, names_to="Predictor", values_to="Coef")
df_se   <- as.data.frame(se_mat) %>%
  rownames_to_column("Outcome") %>%
  pivot_longer(-Outcome, names_to="Predictor", values_to="SE")
df_z    <- as.data.frame(z_mat) %>%
  rownames_to_column("Outcome") %>%
  pivot_longer(-Outcome, names_to="Predictor", values_to="z")
df_p    <- as.data.frame(p_mat) %>%
  rownames_to_column("Outcome") %>%
  pivot_longer(-Outcome, names_to="Predictor", values_to="p.value")

# 4. join and format, adding stars
results <- df_coef %>%
  left_join(df_se, by=c("Outcome","Predictor")) %>%
  left_join(df_z,  by=c("Outcome","Predictor")) %>%
  left_join(df_p,  by=c("Outcome","Predictor")) %>%
  mutate(
    OR      = exp(Coef),
    across(c(Coef, SE, z, OR, p.value), ~ round(., 3)),
    stars   = case_when(
      p.value < 0.001 ~ "***",
      p.value < 0.01  ~ "**",
      p.value < 0.05  ~ "*",
      TRUE            ~ ""
    ),
    OR       = paste0(OR, stars)
  ) %>%
  select(Outcome, Predictor, OR, Coef, SE, z, p.value)

# 5. render as styled HTML
kable(
  results,
  format     = "html",
  table.attr = 'class="table table-striped"',
  col.names  = c("Outcome", "Predictor", "OR", "Coef", "SE", "z-score", "p-value"),
  caption    = "Multinomial logit: Odds Ratios (with significance), Coefs, SEs, z-scores & p-values"
) %>%
  kable_styling(
    bootstrap_options = c("striped", "hover", "condensed", "responsive"),
    full_width        = FALSE
  )
```

# P95: Multinomial regression

### Question:

**Statement: Satisfaction with public transportation.**

### Potential Answers:
- 1: will be increased
- 2: will be maintained
- 3: will be decreased

```{r}
trips <- readRDS("data/008-24 BBDD Procesamiento Etapas.rds")
hog <- readRDS("data/008-24 BBDD Procesamiento Hogares.rds")
per <- readRDS("data/008-24 BBDD Procesamiento Personas.rds")

per_complt <- per %>%
  left_join(hog,by="ID_Hogar")

dependent_variable<- "P95"
independent_variables <- c("P1", "P3", "P42",
                           "P50", "P12", "P14",
                           "Edad", "P10", "P12","P13","P15", "P14", "P82", "P83")

regressor<- per_complt %>%
  select(all_of(dependent_variable), all_of(independent_variables))


regressor <- regressor %>%
  mutate(
    across(
      where(is.labelled),    # pick all haven_labelled columns
      ~ zap_labels(.)        # strip off the labels, leaving the underlying numeric
    )
  )
regressor$P95 <- as.factor(regressor$P95)
regressor$P95 <- relevel(regressor$P95, ref = "2") # Relevel to set the reference category

regressor<-regressor%>%
  rename(house=P1,
         pop_num=P3,
         major_trans_2020=P42,
         income= P50,
         rent_own= P82,
         live_time= P83
         )

regressor<-regressor%>%
  rename(edu_att= P12,
         occupation= P14,
         gender= P10,
         age= Edad
         )

regressor$house <- as.factor(regressor$house)
regressor$house<- relevel(regressor$house, ref = "4") # Relevel to set the reference category
regressor$rent_own<- as.factor(regressor$rent_own) # own =1, rent =2
regressor$rent_own <- relevel(regressor$rent_own, ref = "1") # Relevel to set the reference category
regressor$gender <- as.factor(regressor$gender) #female =1, male=2
regressor$gender <- relevel(regressor$gender, ref = "2") # Relevel to set the reference category


regressor$edu_att <- dplyr::case_when(
  regressor$edu_att %in% c(1, 2, 3) ~ "Primary",
  regressor$edu_att %in% c(4, 5) ~ "LowerSecondary",
  regressor$edu_att %in% c(6, 7) ~ "UpperSecondary",
  regressor$edu_att %in% c(8, 9) ~ "Technological",
  regressor$edu_att %in% c(10, 11, 12, 13) ~ "University",
  regressor$edu_att == 97 ~ "NA",
)
regressor$edu_att <- as.factor(regressor$edu_att)
regressor$edu_att <- relevel(regressor$edu_att, ref = "UpperSecondary") # Relevel to set the reference category

regressor<-regressor %>%
  mutate(major_trans_2020= case_when(
    major_trans_2020 %in% c(1,2,3,4,5,6,10,16) ~ "public_tansit",
    major_trans_2020 %in% c(7,8,9) ~ "informal",
    major_trans_2020 %in% c(11,12) ~ "taxi",
    major_trans_2020 %in% c(22,23) ~ "personal_veh",
    major_trans_2020 %in% c(24,25) ~"motorcyle",
    major_trans_2020 %in% c(25,27,28,17) ~ "bicycle",
    major_trans_2020==34 ~ "walking",
    TRUE ~ "other"
))
regressor$major_trans_2020<-as.factor(regressor$major_trans_2020)
regressor$major_trans_2020<-relevel(regressor$major_trans_2020,ref = "other")

regressor <- regressor %>%
  mutate(
    # 1) if P13 not NA, take P13, otherwise keep original P14
    occupation = if_else(!is.na(P13), as.character(P13), as.character(occupation)),
    # 2) if P15 not NA, paste it to the (possibly updated) P14; else leave as is
    occupation = if_else(
      !is.na(P15),
      paste(occupation, P15, sep = " / "),  # use whatever separator you like
      occupation
    )
  )
regressor$occupation <- str_remove_all(regressor$occupation, "(^NA\\s*/\\s*)|(\\s*/\\s*NA$)")

regressor<-regressor%>%
  mutate(occupation= as.numeric(occupation)) %>%
  select(-P13, -P15)

regressor<-regressor%>%
  mutate(occupation= case_when(
    occupation %in% c(1,2,3,4,5,22) ~ "student",
    occupation %in% c(11,12) ~ "employed",
    occupation %in% c(13,14,15,16) ~ "self-employed",
    occupation %in% c(6,7,8,9,17) ~ "informal",
    occupation == 97 ~ "NA",
    TRUE ~ "Other-unemployed"
  ))
regressor$occupation <- as.factor(regressor$occupation)
regressor$occupation <- relevel(regressor$occupation, ref = "Other-unemployed") # Relevel to set the reference category

regressor<-regressor%>%
  mutate(income= case_when(
    income %in% c(1,2,3) ~ "Low",
    income %in% c(4,5,6) ~ "lower-mid",
    income %in% c(7,8) ~ "Upper-mid",
    income %in% c(9,10,11) ~ "High",
    TRUE ~ "Other"
    ))%>%
  mutate(income = as.factor(income))
regressor$income <- relevel(regressor$income, ref = "Other") # Relevel to set the reference category

regressor<-regressor%>%
  mutate(live_time= case_when(
    live_time %in% c(1,2) ~ "short",
    live_time %in% c(3,4) ~ "medium",
    live_time %in% c(5,6) ~ "long",
    TRUE ~ "NA"
  )) %>%
  mutate(live_time = as.factor(live_time))

regressor$live_time <- relevel(regressor$live_time, ref = "medium") # Relevel to set the reference category

regressor <- regressor %>%
  mutate(
    age = if_else(
      age %in% c(1,2),
      "under_18",
      as.character(age)      # keeps the original age for everyone else
    )
  )%>%
  mutate(age = as.factor(age))



model_house<-multinom(P95~.,data=regressor)

z<-summary(model_house)$coefficients/summary(model_house)$standard.errors
p_values<- (1 - pnorm(abs(z), 0, 1)) * 2

# 1. grab raw summary
s       <- summary(model_house)
coef_mat<- s$coefficients
se_mat  <- s$standard.errors

# 2. compute z-scores & p-values
z_mat <- coef_mat / se_mat
p_mat <- 2 * pnorm(-abs(z_mat))

# 3. pivot to long form
df_coef <- as.data.frame(coef_mat) %>%
  rownames_to_column("Outcome") %>%
  pivot_longer(-Outcome, names_to="Predictor", values_to="Coef")
df_se   <- as.data.frame(se_mat) %>%
  rownames_to_column("Outcome") %>%
  pivot_longer(-Outcome, names_to="Predictor", values_to="SE")
df_z    <- as.data.frame(z_mat) %>%
  rownames_to_column("Outcome") %>%
  pivot_longer(-Outcome, names_to="Predictor", values_to="z")
df_p    <- as.data.frame(p_mat) %>%
  rownames_to_column("Outcome") %>%
  pivot_longer(-Outcome, names_to="Predictor", values_to="p.value")

# 4. join and format, adding stars
results <- df_coef %>%
  left_join(df_se, by=c("Outcome","Predictor")) %>%
  left_join(df_z,  by=c("Outcome","Predictor")) %>%
  left_join(df_p,  by=c("Outcome","Predictor")) %>%
  mutate(
    OR      = exp(Coef),
    across(c(Coef, SE, z, OR, p.value), ~ round(., 3)),
    stars   = case_when(
      p.value < 0.001 ~ "***",
      p.value < 0.01  ~ "**",
      p.value < 0.05  ~ "*",
      TRUE            ~ ""
    ),
    OR       = paste0(OR, stars)
  ) %>%
  select(Outcome, Predictor, OR, Coef, SE, z, p.value)

# 5. render as styled HTML
kable(
  results,
  format     = "html",
  table.attr = 'class="table table-striped"',
  col.names  = c("Outcome", "Predictor", "OR", "Coef", "SE", "z-score", "p-value"),
  caption    = "Multinomial logit: Odds Ratios (with significance), Coefs, SEs, z-scores & p-values"
) %>%
  kable_styling(
    bootstrap_options = c("striped", "hover", "condensed", "responsive"),
    full_width        = FALSE
  )
```

# P96: multinomial regression

### Question:

**Statement: Travel time/commute to your most frequent travel destination.**

### Potential Answers:
- 1: It will increase
- 2: Will be maintained
- 3: It will decrease


```{r}
trips <- readRDS("data/008-24 BBDD Procesamiento Etapas.rds")
hog <- readRDS("data/008-24 BBDD Procesamiento Hogares.rds")
per <- readRDS("data/008-24 BBDD Procesamiento Personas.rds")

per_complt <- per %>%
  left_join(hog,by="ID_Hogar")

dependent_variable<- "P96"
independent_variables <- c("P1", "P3", "P42",
                           "P50", "P12", "P14",
                           "Edad", "P10", "P12","P13","P15", "P14", "P82", "P83")

regressor<- per_complt %>%
  select(all_of(dependent_variable), all_of(independent_variables))


regressor <- regressor %>%
  mutate(
    across(
      where(is.labelled),    # pick all haven_labelled columns
      ~ zap_labels(.)        # strip off the labels, leaving the underlying numeric
    )
  )
regressor$P96 <- as.factor(regressor$P96)
regressor$P96 <- relevel(regressor$P96, ref = "2") # Relevel to set the reference category

regressor<-regressor%>%
  rename(house=P1,
         pop_num=P3,
         major_trans_2020=P42,
         income= P50,
         rent_own= P82,
         live_time= P83
         )

regressor<-regressor%>%
  rename(edu_att= P12,
         occupation= P14,
         gender= P10,
         age= Edad
         )

regressor$house <- as.factor(regressor$house)
regressor$house<- relevel(regressor$house, ref = "4") # Relevel to set the reference category
regressor$rent_own<- as.factor(regressor$rent_own) # own =1, rent =2
regressor$rent_own <- relevel(regressor$rent_own, ref = "1") # Relevel to set the reference category
regressor$gender <- as.factor(regressor$gender) #female =1, male=2
regressor$gender <- relevel(regressor$gender, ref = "2") # Relevel to set the reference category


regressor$edu_att <- dplyr::case_when(
  regressor$edu_att %in% c(1, 2, 3) ~ "Primary",
  regressor$edu_att %in% c(4, 5) ~ "LowerSecondary",
  regressor$edu_att %in% c(6, 7) ~ "UpperSecondary",
  regressor$edu_att %in% c(8, 9) ~ "Technological",
  regressor$edu_att %in% c(10, 11, 12, 13) ~ "University",
  regressor$edu_att == 97 ~ "NA",
)
regressor$edu_att <- as.factor(regressor$edu_att)
regressor$edu_att <- relevel(regressor$edu_att, ref = "UpperSecondary") # Relevel to set the reference category

regressor<-regressor %>%
  mutate(major_trans_2020= case_when(
    major_trans_2020 %in% c(1,2,3,4,5,6,10,16) ~ "public_tansit",
    major_trans_2020 %in% c(7,8,9) ~ "informal",
    major_trans_2020 %in% c(11,12) ~ "taxi",
    major_trans_2020 %in% c(22,23) ~ "personal_veh",
    major_trans_2020 %in% c(24,25) ~"motorcyle",
    major_trans_2020 %in% c(25,27,28,17) ~ "bicycle",
    major_trans_2020==34 ~ "walking",
    TRUE ~ "other"
))
regressor$major_trans_2020<-as.factor(regressor$major_trans_2020)
regressor$major_trans_2020<-relevel(regressor$major_trans_2020,ref = "other")

regressor <- regressor %>%
  mutate(
    # 1) if P13 not NA, take P13, otherwise keep original P14
    occupation = if_else(!is.na(P13), as.character(P13), as.character(occupation)),
    # 2) if P15 not NA, paste it to the (possibly updated) P14; else leave as is
    occupation = if_else(
      !is.na(P15),
      paste(occupation, P15, sep = " / "),  # use whatever separator you like
      occupation
    )
  )
regressor$occupation <- str_remove_all(regressor$occupation, "(^NA\\s*/\\s*)|(\\s*/\\s*NA$)")

regressor<-regressor%>%
  mutate(occupation= as.numeric(occupation)) %>%
  select(-P13, -P15)

regressor<-regressor%>%
  mutate(occupation= case_when(
    occupation %in% c(1,2,3,4,5,22) ~ "student",
    occupation %in% c(11,12) ~ "employed",
    occupation %in% c(13,14,15,16) ~ "self-employed",
    occupation %in% c(6,7,8,9,17) ~ "informal",
    occupation == 97 ~ "NA",
    TRUE ~ "Other-unemployed"
  ))
regressor$occupation <- as.factor(regressor$occupation)
regressor$occupation <- relevel(regressor$occupation, ref = "Other-unemployed") # Relevel to set the reference category

regressor<-regressor%>%
  mutate(income= case_when(
    income %in% c(1,2,3) ~ "Low",
    income %in% c(4,5,6) ~ "lower-mid",
    income %in% c(7,8) ~ "Upper-mid",
    income %in% c(9,10,11) ~ "High",
    TRUE ~ "Other"
    ))%>%
  mutate(income = as.factor(income))
regressor$income <- relevel(regressor$income, ref = "Other") # Relevel to set the reference category

regressor<-regressor%>%
  mutate(live_time= case_when(
    live_time %in% c(1,2) ~ "short",
    live_time %in% c(3,4) ~ "medium",
    live_time %in% c(5,6) ~ "long",
    TRUE ~ "NA"
  )) %>%
  mutate(live_time = as.factor(live_time))

regressor$live_time <- relevel(regressor$live_time, ref = "medium") # Relevel to set the reference category

regressor <- regressor %>%
  mutate(
    age = if_else(
      age %in% c(1,2),
      "under_18",
      as.character(age)      # keeps the original age for everyone else
    )
  )%>%
  mutate(age = as.factor(age))



model_house<-multinom(P96~.,data=regressor)

z<-summary(model_house)$coefficients/summary(model_house)$standard.errors
p_values<- (1 - pnorm(abs(z), 0, 1)) * 2

# 1. grab raw summary
s       <- summary(model_house)
coef_mat<- s$coefficients
se_mat  <- s$standard.errors

# 2. compute z-scores & p-values
z_mat <- coef_mat / se_mat
p_mat <- 2 * pnorm(-abs(z_mat))

# 3. pivot to long form
df_coef <- as.data.frame(coef_mat) %>%
  rownames_to_column("Outcome") %>%
  pivot_longer(-Outcome, names_to="Predictor", values_to="Coef")
df_se   <- as.data.frame(se_mat) %>%
  rownames_to_column("Outcome") %>%
  pivot_longer(-Outcome, names_to="Predictor", values_to="SE")
df_z    <- as.data.frame(z_mat) %>%
  rownames_to_column("Outcome") %>%
  pivot_longer(-Outcome, names_to="Predictor", values_to="z")
df_p    <- as.data.frame(p_mat) %>%
  rownames_to_column("Outcome") %>%
  pivot_longer(-Outcome, names_to="Predictor", values_to="p.value")

# 4. join and format, adding stars
results <- df_coef %>%
  left_join(df_se, by=c("Outcome","Predictor")) %>%
  left_join(df_z,  by=c("Outcome","Predictor")) %>%
  left_join(df_p,  by=c("Outcome","Predictor")) %>%
  mutate(
    OR      = exp(Coef),
    across(c(Coef, SE, z, OR, p.value), ~ round(., 3)),
    stars   = case_when(
      p.value < 0.001 ~ "***",
      p.value < 0.01  ~ "**",
      p.value < 0.05  ~ "*",
      TRUE            ~ ""
    ),
    OR       = paste0(OR, stars)
  ) %>%
  select(Outcome, Predictor, OR, Coef, SE, z, p.value)

# 5. render as styled HTML
kable(
  results,
  format     = "html",
  table.attr = 'class="table table-striped"',
  col.names  = c("Outcome", "Predictor", "OR", "Coef", "SE", "z-score", "p-value"),
  caption    = "Multinomial logit: Odds Ratios (with significance), Coefs, SEs, z-scores & p-values"
) %>%
  kable_styling(
    bootstrap_options = c("striped", "hover", "condensed", "responsive"),
    full_width        = FALSE
  )
```

# P98: multinomial regression

### Question:

**Statement: Hearing pollution**

### Potential Answers:
- 1: It will increase
- 2: Will be maintained
- 3: It will decrease


```{r}
trips <- readRDS("data/008-24 BBDD Procesamiento Etapas.rds")
hog <- readRDS("data/008-24 BBDD Procesamiento Hogares.rds")
per <- readRDS("data/008-24 BBDD Procesamiento Personas.rds")

per_complt <- per %>%
  left_join(hog,by="ID_Hogar")

dependent_variable<- "P98"
independent_variables <- c("P1", "P3", "P42",
                           "P50", "P12", "P14",
                           "Edad", "P10", "P12","P13","P15", "P14", "P82", "P83")

regressor<- per_complt %>%
  select(all_of(dependent_variable), all_of(independent_variables))


regressor <- regressor %>%
  mutate(
    across(
      where(is.labelled),    # pick all haven_labelled columns
      ~ zap_labels(.)        # strip off the labels, leaving the underlying numeric
    )
  )
regressor$P98 <- as.factor(regressor$P98)
regressor$P98 <- relevel(regressor$P98, ref = "2") # Relevel to set the reference category

regressor<-regressor%>%
  rename(house=P1,
         pop_num=P3,
         major_trans_2020=P42,
         income= P50,
         rent_own= P82,
         live_time= P83
         )

regressor<-regressor%>%
  rename(edu_att= P12,
         occupation= P14,
         gender= P10,
         age= Edad
         )

regressor$house <- as.factor(regressor$house)
regressor$house<- relevel(regressor$house, ref = "4") # Relevel to set the reference category
regressor$rent_own<- as.factor(regressor$rent_own) # own =1, rent =2
regressor$rent_own <- relevel(regressor$rent_own, ref = "1") # Relevel to set the reference category
regressor$gender <- as.factor(regressor$gender) #female =1, male=2
regressor$gender <- relevel(regressor$gender, ref = "2") # Relevel to set the reference category


regressor$edu_att <- dplyr::case_when(
  regressor$edu_att %in% c(1, 2, 3) ~ "Primary",
  regressor$edu_att %in% c(4, 5) ~ "LowerSecondary",
  regressor$edu_att %in% c(6, 7) ~ "UpperSecondary",
  regressor$edu_att %in% c(8, 9) ~ "Technological",
  regressor$edu_att %in% c(10, 11, 12, 13) ~ "University",
  regressor$edu_att == 97 ~ "NA",
)
regressor$edu_att <- as.factor(regressor$edu_att)
regressor$edu_att <- relevel(regressor$edu_att, ref = "UpperSecondary") # Relevel to set the reference category

regressor<-regressor %>%
  mutate(major_trans_2020= case_when(
    major_trans_2020 %in% c(1,2,3,4,5,6,10,16) ~ "public_tansit",
    major_trans_2020 %in% c(7,8,9) ~ "informal",
    major_trans_2020 %in% c(11,12) ~ "taxi",
    major_trans_2020 %in% c(22,23) ~ "personal_veh",
    major_trans_2020 %in% c(24,25) ~"motorcyle",
    major_trans_2020 %in% c(25,27,28,17) ~ "bicycle",
    major_trans_2020==34 ~ "walking",
    TRUE ~ "other"
))
regressor$major_trans_2020<-as.factor(regressor$major_trans_2020)
regressor$major_trans_2020<-relevel(regressor$major_trans_2020,ref = "other")

regressor <- regressor %>%
  mutate(
    # 1) if P13 not NA, take P13, otherwise keep original P14
    occupation = if_else(!is.na(P13), as.character(P13), as.character(occupation)),
    # 2) if P15 not NA, paste it to the (possibly updated) P14; else leave as is
    occupation = if_else(
      !is.na(P15),
      paste(occupation, P15, sep = " / "),  # use whatever separator you like
      occupation
    )
  )
regressor$occupation <- str_remove_all(regressor$occupation, "(^NA\\s*/\\s*)|(\\s*/\\s*NA$)")

regressor<-regressor%>%
  mutate(occupation= as.numeric(occupation)) %>%
  select(-P13, -P15)

regressor<-regressor%>%
  mutate(occupation= case_when(
    occupation %in% c(1,2,3,4,5,22) ~ "student",
    occupation %in% c(11,12) ~ "employed",
    occupation %in% c(13,14,15,16) ~ "self-employed",
    occupation %in% c(6,7,8,9,17) ~ "informal",
    occupation == 97 ~ "NA",
    TRUE ~ "Other-unemployed"
  ))
regressor$occupation <- as.factor(regressor$occupation)
regressor$occupation <- relevel(regressor$occupation, ref = "Other-unemployed") # Relevel to set the reference category

regressor<-regressor%>%
  mutate(income= case_when(
    income %in% c(1,2,3) ~ "Low",
    income %in% c(4,5,6) ~ "lower-mid",
    income %in% c(7,8) ~ "Upper-mid",
    income %in% c(9,10,11) ~ "High",
    TRUE ~ "Other"
    ))%>%
  mutate(income = as.factor(income))
regressor$income <- relevel(regressor$income, ref = "Other") # Relevel to set the reference category

regressor<-regressor%>%
  mutate(live_time= case_when(
    live_time %in% c(1,2) ~ "short",
    live_time %in% c(3,4) ~ "medium",
    live_time %in% c(5,6) ~ "long",
    TRUE ~ "NA"
  )) %>%
  mutate(live_time = as.factor(live_time))

regressor$live_time <- relevel(regressor$live_time, ref = "medium") # Relevel to set the reference category

regressor <- regressor %>%
  mutate(
    age = if_else(
      age %in% c(1,2),
      "under_18",
      as.character(age)      # keeps the original age for everyone else
    )
  )%>%
  mutate(age = as.factor(age))



model_house<-multinom(P98~.,data=regressor)

z<-summary(model_house)$coefficients/summary(model_house)$standard.errors
p_values<- (1 - pnorm(abs(z), 0, 1)) * 2

# 1. grab raw summary
s       <- summary(model_house)
coef_mat<- s$coefficients
se_mat  <- s$standard.errors

# 2. compute z-scores & p-values
z_mat <- coef_mat / se_mat
p_mat <- 2 * pnorm(-abs(z_mat))

# 3. pivot to long form
df_coef <- as.data.frame(coef_mat) %>%
  rownames_to_column("Outcome") %>%
  pivot_longer(-Outcome, names_to="Predictor", values_to="Coef")
df_se   <- as.data.frame(se_mat) %>%
  rownames_to_column("Outcome") %>%
  pivot_longer(-Outcome, names_to="Predictor", values_to="SE")
df_z    <- as.data.frame(z_mat) %>%
  rownames_to_column("Outcome") %>%
  pivot_longer(-Outcome, names_to="Predictor", values_to="z")
df_p    <- as.data.frame(p_mat) %>%
  rownames_to_column("Outcome") %>%
  pivot_longer(-Outcome, names_to="Predictor", values_to="p.value")

# 4. join and format, adding stars
results <- df_coef %>%
  left_join(df_se, by=c("Outcome","Predictor")) %>%
  left_join(df_z,  by=c("Outcome","Predictor")) %>%
  left_join(df_p,  by=c("Outcome","Predictor")) %>%
  mutate(
    OR      = exp(Coef),
    across(c(Coef, SE, z, OR, p.value), ~ round(., 3)),
    stars   = case_when(
      p.value < 0.001 ~ "***",
      p.value < 0.01  ~ "**",
      p.value < 0.05  ~ "*",
      TRUE            ~ ""
    ),
    OR       = paste0(OR, stars)
  ) %>%
  select(Outcome, Predictor, OR, Coef, SE, z, p.value)

# 5. render as styled HTML
kable(
  results,
  format     = "html",
  table.attr = 'class="table table-striped"',
  col.names  = c("Outcome", "Predictor", "OR", "Coef", "SE", "z-score", "p-value"),
  caption    = "Multinomial logit: Odds Ratios (with significance), Coefs, SEs, z-scores & p-values"
) %>%
  kable_styling(
    bootstrap_options = c("striped", "hover", "condensed", "responsive"),
    full_width        = FALSE
  )
```

# P100: multinomial regression

### Question:

**Statement: Public spaces (sidewalks, green areas, parks)**

### Potential Answers:
- 1: It will increase
- 2: Will be maintained
- 3: It will decrease

```{r}
trips <- readRDS("data/008-24 BBDD Procesamiento Etapas.rds")
hog <- readRDS("data/008-24 BBDD Procesamiento Hogares.rds")
per <- readRDS("data/008-24 BBDD Procesamiento Personas.rds")

per_complt <- per %>%
  left_join(hog,by="ID_Hogar")

dependent_variable<- "P100"
independent_variables <- c("P1", "P3", "P42",
                           "P50", "P12", "P14",
                           "Edad", "P10", "P12","P13","P15", "P14", "P82", "P83")

regressor<- per_complt %>%
  select(all_of(dependent_variable), all_of(independent_variables))


regressor <- regressor %>%
  mutate(
    across(
      where(is.labelled),    # pick all haven_labelled columns
      ~ zap_labels(.)        # strip off the labels, leaving the underlying numeric
    )
  )
regressor$P100 <- as.factor(regressor$P100)
regressor$P100 <- relevel(regressor$P100, ref = "2") # Relevel to set the reference category

regressor<-regressor%>%
  rename(house=P1,
         pop_num=P3,
         major_trans_2020=P42,
         income= P50,
         rent_own= P82,
         live_time= P83
         )

regressor<-regressor%>%
  rename(edu_att= P12,
         occupation= P14,
         gender= P10,
         age= Edad
         )

regressor$house <- as.factor(regressor$house)
regressor$house<- relevel(regressor$house, ref = "4") # Relevel to set the reference category
regressor$rent_own<- as.factor(regressor$rent_own) # own =1, rent =2
regressor$rent_own <- relevel(regressor$rent_own, ref = "1") # Relevel to set the reference category
regressor$gender <- as.factor(regressor$gender) #female =1, male=2
regressor$gender <- relevel(regressor$gender, ref = "2") # Relevel to set the reference category


regressor$edu_att <- dplyr::case_when(
  regressor$edu_att %in% c(1, 2, 3) ~ "Primary",
  regressor$edu_att %in% c(4, 5) ~ "LowerSecondary",
  regressor$edu_att %in% c(6, 7) ~ "UpperSecondary",
  regressor$edu_att %in% c(8, 9) ~ "Technological",
  regressor$edu_att %in% c(10, 11, 12, 13) ~ "University",
  regressor$edu_att == 97 ~ "NA",
)
regressor$edu_att <- as.factor(regressor$edu_att)
regressor$edu_att <- relevel(regressor$edu_att, ref = "UpperSecondary") # Relevel to set the reference category

regressor<-regressor %>%
  mutate(major_trans_2020= case_when(
    major_trans_2020 %in% c(1,2,3,4,5,6,10,16) ~ "public_tansit",
    major_trans_2020 %in% c(7,8,9) ~ "informal",
    major_trans_2020 %in% c(11,12) ~ "taxi",
    major_trans_2020 %in% c(22,23) ~ "personal_veh",
    major_trans_2020 %in% c(24,25) ~"motorcyle",
    major_trans_2020 %in% c(25,27,28,17) ~ "bicycle",
    major_trans_2020==34 ~ "walking",
    TRUE ~ "other"
))
regressor$major_trans_2020<-as.factor(regressor$major_trans_2020)
regressor$major_trans_2020<-relevel(regressor$major_trans_2020,ref = "other")

regressor <- regressor %>%
  mutate(
    # 1) if P13 not NA, take P13, otherwise keep original P14
    occupation = if_else(!is.na(P13), as.character(P13), as.character(occupation)),
    # 2) if P15 not NA, paste it to the (possibly updated) P14; else leave as is
    occupation = if_else(
      !is.na(P15),
      paste(occupation, P15, sep = " / "),  # use whatever separator you like
      occupation
    )
  )
regressor$occupation <- str_remove_all(regressor$occupation, "(^NA\\s*/\\s*)|(\\s*/\\s*NA$)")

regressor<-regressor%>%
  mutate(occupation= as.numeric(occupation)) %>%
  select(-P13, -P15)

regressor<-regressor%>%
  mutate(occupation= case_when(
    occupation %in% c(1,2,3,4,5,22) ~ "student",
    occupation %in% c(11,12) ~ "employed",
    occupation %in% c(13,14,15,16) ~ "self-employed",
    occupation %in% c(6,7,8,9,17) ~ "informal",
    occupation == 97 ~ "NA",
    TRUE ~ "Other-unemployed"
  ))
regressor$occupation <- as.factor(regressor$occupation)
regressor$occupation <- relevel(regressor$occupation, ref = "Other-unemployed") # Relevel to set the reference category

regressor<-regressor%>%
  mutate(income= case_when(
    income %in% c(1,2,3) ~ "Low",
    income %in% c(4,5,6) ~ "lower-mid",
    income %in% c(7,8) ~ "Upper-mid",
    income %in% c(9,10,11) ~ "High",
    TRUE ~ "Other"
    ))%>%
  mutate(income = as.factor(income))
regressor$income <- relevel(regressor$income, ref = "Other") # Relevel to set the reference category

regressor<-regressor%>%
  mutate(live_time= case_when(
    live_time %in% c(1,2) ~ "short",
    live_time %in% c(3,4) ~ "medium",
    live_time %in% c(5,6) ~ "long",
    TRUE ~ "NA"
  )) %>%
  mutate(live_time = as.factor(live_time))

regressor$live_time <- relevel(regressor$live_time, ref = "medium") # Relevel to set the reference category

regressor <- regressor %>%
  mutate(
    age = if_else(
      age %in% c(1,2),
      "under_18",
      as.character(age)      # keeps the original age for everyone else
    )
  )%>%
  mutate(age = as.factor(age))



model_house<-multinom(P100~.,data=regressor)

z<-summary(model_house)$coefficients/summary(model_house)$standard.errors
p_values<- (1 - pnorm(abs(z), 0, 1)) * 2

# 1. grab raw summary
s       <- summary(model_house)
coef_mat<- s$coefficients
se_mat  <- s$standard.errors

# 2. compute z-scores & p-values
z_mat <- coef_mat / se_mat
p_mat <- 2 * pnorm(-abs(z_mat))

# 3. pivot to long form
df_coef <- as.data.frame(coef_mat) %>%
  rownames_to_column("Outcome") %>%
  pivot_longer(-Outcome, names_to="Predictor", values_to="Coef")
df_se   <- as.data.frame(se_mat) %>%
  rownames_to_column("Outcome") %>%
  pivot_longer(-Outcome, names_to="Predictor", values_to="SE")
df_z    <- as.data.frame(z_mat) %>%
  rownames_to_column("Outcome") %>%
  pivot_longer(-Outcome, names_to="Predictor", values_to="z")
df_p    <- as.data.frame(p_mat) %>%
  rownames_to_column("Outcome") %>%
  pivot_longer(-Outcome, names_to="Predictor", values_to="p.value")

# 4. join and format, adding stars
results <- df_coef %>%
  left_join(df_se, by=c("Outcome","Predictor")) %>%
  left_join(df_z,  by=c("Outcome","Predictor")) %>%
  left_join(df_p,  by=c("Outcome","Predictor")) %>%
  mutate(
    OR      = exp(Coef),
    across(c(Coef, SE, z, OR, p.value), ~ round(., 3)),
    stars   = case_when(
      p.value < 0.001 ~ "***",
      p.value < 0.01  ~ "**",
      p.value < 0.05  ~ "*",
      TRUE            ~ ""
    ),
    OR       = paste0(OR, stars)
  ) %>%
  select(Outcome, Predictor, OR, Coef, SE, z, p.value)

# 5. render as styled HTML
kable(
  results,
  format     = "html",
  table.attr = 'class="table table-striped"',
  col.names  = c("Outcome", "Predictor", "OR", "Coef", "SE", "z-score", "p-value"),
  caption    = "Multinomial logit: Odds Ratios (with significance), Coefs, SEs, z-scores & p-values"
) %>%
  kable_styling(
    bootstrap_options = c("striped", "hover", "condensed", "responsive"),
    full_width        = FALSE
  )
```

# P101: multinomial regression

### Question:

**Statement: New housing projects**

### Potential Answers:
- 1: It will increase
- 2: Will be maintained
- 3: It will decrease

```{r}
trips <- readRDS("data/008-24 BBDD Procesamiento Etapas.rds")
hog <- readRDS("data/008-24 BBDD Procesamiento Hogares.rds")
per <- readRDS("data/008-24 BBDD Procesamiento Personas.rds")

per_complt <- per %>%
  left_join(hog,by="ID_Hogar")

dependent_variable<- "P101"
independent_variables <- c("P1", "P3", "P42",
                           "P50", "P12", "P14",
                           "Edad", "P10", "P12","P13","P15", "P14", "P82", "P83")

regressor<- per_complt %>%
  select(all_of(dependent_variable), all_of(independent_variables))


regressor <- regressor %>%
  mutate(
    across(
      where(is.labelled),    # pick all haven_labelled columns
      ~ zap_labels(.)        # strip off the labels, leaving the underlying numeric
    )
  )
regressor$P101 <- as.factor(regressor$P101)
regressor$P101 <- relevel(regressor$P101, ref = "2") # Relevel to set the reference category

regressor<-regressor%>%
  rename(house=P1,
         pop_num=P3,
         major_trans_2020=P42,
         income= P50,
         rent_own= P82,
         live_time= P83
         )

regressor<-regressor%>%
  rename(edu_att= P12,
         occupation= P14,
         gender= P10,
         age= Edad
         )

regressor$house <- as.factor(regressor$house)
regressor$house<- relevel(regressor$house, ref = "4") # Relevel to set the reference category
regressor$rent_own<- as.factor(regressor$rent_own) # own =1, rent =2
regressor$rent_own <- relevel(regressor$rent_own, ref = "1") # Relevel to set the reference category
regressor$gender <- as.factor(regressor$gender) #female =1, male=2
regressor$gender <- relevel(regressor$gender, ref = "2") # Relevel to set the reference category


regressor$edu_att <- dplyr::case_when(
  regressor$edu_att %in% c(1, 2, 3) ~ "Primary",
  regressor$edu_att %in% c(4, 5) ~ "LowerSecondary",
  regressor$edu_att %in% c(6, 7) ~ "UpperSecondary",
  regressor$edu_att %in% c(8, 9) ~ "Technological",
  regressor$edu_att %in% c(10, 11, 12, 13) ~ "University",
  regressor$edu_att == 97 ~ "NA",
)
regressor$edu_att <- as.factor(regressor$edu_att)
regressor$edu_att <- relevel(regressor$edu_att, ref = "UpperSecondary") # Relevel to set the reference category

regressor<-regressor %>%
  mutate(major_trans_2020= case_when(
    major_trans_2020 %in% c(1,2,3,4,5,6,10,16) ~ "public_tansit",
    major_trans_2020 %in% c(7,8,9) ~ "informal",
    major_trans_2020 %in% c(11,12) ~ "taxi",
    major_trans_2020 %in% c(22,23) ~ "personal_veh",
    major_trans_2020 %in% c(24,25) ~"motorcyle",
    major_trans_2020 %in% c(25,27,28,17) ~ "bicycle",
    major_trans_2020==34 ~ "walking",
    TRUE ~ "other"
))
regressor$major_trans_2020<-as.factor(regressor$major_trans_2020)
regressor$major_trans_2020<-relevel(regressor$major_trans_2020,ref = "other")

regressor <- regressor %>%
  mutate(
    # 1) if P13 not NA, take P13, otherwise keep original P14
    occupation = if_else(!is.na(P13), as.character(P13), as.character(occupation)),
    # 2) if P15 not NA, paste it to the (possibly updated) P14; else leave as is
    occupation = if_else(
      !is.na(P15),
      paste(occupation, P15, sep = " / "),  # use whatever separator you like
      occupation
    )
  )
regressor$occupation <- str_remove_all(regressor$occupation, "(^NA\\s*/\\s*)|(\\s*/\\s*NA$)")

regressor<-regressor%>%
  mutate(occupation= as.numeric(occupation)) %>%
  select(-P13, -P15)

regressor<-regressor%>%
  mutate(occupation= case_when(
    occupation %in% c(1,2,3,4,5,22) ~ "student",
    occupation %in% c(11,12) ~ "employed",
    occupation %in% c(13,14,15,16) ~ "self-employed",
    occupation %in% c(6,7,8,9,17) ~ "informal",
    occupation == 97 ~ "NA",
    TRUE ~ "Other-unemployed"
  ))
regressor$occupation <- as.factor(regressor$occupation)
regressor$occupation <- relevel(regressor$occupation, ref = "Other-unemployed") # Relevel to set the reference category

regressor<-regressor%>%
  mutate(income= case_when(
    income %in% c(1,2,3) ~ "Low",
    income %in% c(4,5,6) ~ "lower-mid",
    income %in% c(7,8) ~ "Upper-mid",
    income %in% c(9,10,11) ~ "High",
    TRUE ~ "Other"
    ))%>%
  mutate(income = as.factor(income))
regressor$income <- relevel(regressor$income, ref = "Other") # Relevel to set the reference category

regressor<-regressor%>%
  mutate(live_time= case_when(
    live_time %in% c(1,2) ~ "short",
    live_time %in% c(3,4) ~ "medium",
    live_time %in% c(5,6) ~ "long",
    TRUE ~ "NA"
  )) %>%
  mutate(live_time = as.factor(live_time))

regressor$live_time <- relevel(regressor$live_time, ref = "medium") # Relevel to set the reference category

regressor <- regressor %>%
  mutate(
    age = if_else(
      age %in% c(1,2),
      "under_18",
      as.character(age)      # keeps the original age for everyone else
    )
  )%>%
  mutate(age = as.factor(age))



model_house<-multinom(P101~.,data=regressor)

z<-summary(model_house)$coefficients/summary(model_house)$standard.errors
p_values<- (1 - pnorm(abs(z), 0, 1)) * 2

# 1. grab raw summary
s       <- summary(model_house)
coef_mat<- s$coefficients
se_mat  <- s$standard.errors

# 2. compute z-scores & p-values
z_mat <- coef_mat / se_mat
p_mat <- 2 * pnorm(-abs(z_mat))

# 3. pivot to long form
df_coef <- as.data.frame(coef_mat) %>%
  rownames_to_column("Outcome") %>%
  pivot_longer(-Outcome, names_to="Predictor", values_to="Coef")
df_se   <- as.data.frame(se_mat) %>%
  rownames_to_column("Outcome") %>%
  pivot_longer(-Outcome, names_to="Predictor", values_to="SE")
df_z    <- as.data.frame(z_mat) %>%
  rownames_to_column("Outcome") %>%
  pivot_longer(-Outcome, names_to="Predictor", values_to="z")
df_p    <- as.data.frame(p_mat) %>%
  rownames_to_column("Outcome") %>%
  pivot_longer(-Outcome, names_to="Predictor", values_to="p.value")

# 4. join and format, adding stars
results <- df_coef %>%
  left_join(df_se, by=c("Outcome","Predictor")) %>%
  left_join(df_z,  by=c("Outcome","Predictor")) %>%
  left_join(df_p,  by=c("Outcome","Predictor")) %>%
  mutate(
    OR      = exp(Coef),
    across(c(Coef, SE, z, OR, p.value), ~ round(., 3)),
    stars   = case_when(
      p.value < 0.001 ~ "***",
      p.value < 0.01  ~ "**",
      p.value < 0.05  ~ "*",
      TRUE            ~ ""
    ),
    OR       = paste0(OR, stars)
  ) %>%
  select(Outcome, Predictor, OR, Coef, SE, z, p.value)

# 5. render as styled HTML
kable(
  results,
  format     = "html",
  table.attr = 'class="table table-striped"',
  col.names  = c("Outcome", "Predictor", "OR", "Coef", "SE", "z-score", "p-value"),
  caption    = "Multinomial logit: Odds Ratios (with significance), Coefs, SEs, z-scores & p-values"
) %>%
  kable_styling(
    bootstrap_options = c("striped", "hover", "condensed", "responsive"),
    full_width        = FALSE
  )
```
